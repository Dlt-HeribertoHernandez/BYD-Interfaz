
<div class="flex flex-col h-full gap-6 animate-fade-in">
  
  <!-- Filters Section -->
  <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
    <div class="flex flex-col md:flex-row md:items-end gap-4">
      <div class="w-full md:w-auto">
        <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Fecha Inicial</label>
        <input type="date" [(ngModel)]="startDate" class="w-full md:w-48 p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 outline-none [color-scheme:light]">
      </div>
      <div class="w-full md:w-auto">
        <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Fecha Final</label>
        <input type="date" [(ngModel)]="endDate" class="w-full md:w-48 p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 outline-none [color-scheme:light]">
      </div>
      <button (click)="fetchOrders()" [disabled]="isLoading()" 
        class="w-full md:w-auto px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow-md shadow-blue-100 transition-all flex items-center justify-center gap-2 disabled:opacity-50">
        @if (isLoading()) {
          <i class="fas fa-circle-notch fa-spin"></i>
        } @else {
          <i class="fas fa-search"></i> Buscar Órdenes
        }
      </button>
    </div>
  </div>

  <!-- Content Area: List & Details -->
  <div class="flex flex-col lg:flex-row gap-6 flex-1 min-h-0">
    
    <!-- Order List -->
    <div class="lg:w-7/12 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
      <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
        <h3 class="font-semibold text-gray-800">Órdenes (dsfacdocori)</h3>
        <span class="text-xs text-gray-500">{{ orders().length }} resultados</span>
      </div>
      <div class="overflow-auto flex-1">
        <table class="w-full text-left border-collapse">
          <thead class="sticky top-0 bg-white z-10">
            <tr class="text-xs font-semibold text-gray-500 border-b border-gray-100 uppercase tracking-wider">
              <th class="px-4 py-3">Sucursal</th>
              <th class="px-4 py-3">Folio (OS)</th>
              <th class="px-4 py-3">Cliente</th>
              <th class="px-4 py-3 text-right">Total</th>
              <th class="px-4 py-3 text-center">Status</th>
            </tr>
          </thead>
          <tbody class="text-sm divide-y divide-gray-100">
            @for (order of orders(); track order.id) {
              <tr class="hover:bg-blue-50/50 cursor-pointer transition-colors" 
                  [class.bg-blue-50]="selectedOrder()?.id === order.id"
                  (click)="selectOrder(order)">
                <td class="px-4 py-3">
                   <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs font-bold">{{ order.branchCode }}</span>
                </td>
                <td class="px-4 py-3 font-medium text-gray-900">{{ order.orderNumber }}</td>
                <td class="px-4 py-3 text-gray-600 truncate max-w-[150px]">{{ order.customerName }}</td>
                <td class="px-4 py-3 text-right font-mono text-gray-700">{{ order.totalAmount | currency }}</td>
                <td class="px-4 py-3 text-center">
                  <span class="px-2 py-1 rounded-full text-[10px] font-bold border uppercase tracking-wide"
                    [ngClass]="getStatusClass(order.status)">
                    {{ order.status }}
                  </span>
                </td>
              </tr>
            }
            @if (orders().length === 0 && !isLoading()) {
              <tr>
                <td colspan="5" class="px-6 py-12 text-center text-gray-400">
                   <p>No hay órdenes para el rango seleccionado.</p>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Order Details (Slide over or Side Panel) -->
    <div class="lg:w-5/12 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden relative transition-all duration-300 ease-in-out">
      @if (selectedOrder()) {
        <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-start">
           <div>
             <div class="flex items-center gap-2">
                <h3 class="font-bold text-gray-900 text-lg">{{ selectedOrder()!.docType }}-{{ selectedOrder()!.orderNumber }}</h3>
             </div>
             <p class="text-xs font-mono text-gray-500 mt-1">
               VIN: {{ selectedOrder()!.vin }}
             </p>
             <p class="text-xs text-gray-500">
               Fecha: {{ selectedOrder()!.date }} | CTE: {{ selectedOrder()!.customerCode }}
             </p>
           </div>
           <button (click)="closeDetail()" class="text-gray-400 hover:text-gray-600 p-1">
             <i class="fas fa-times"></i>
           </button>
        </div>

        <div class="flex-1 overflow-auto p-5 space-y-6">
          
          <!-- Items List -->
          <div>
            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex justify-between items-center">
                <span>Detalle (dsfacdetdori)</span>
                <span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded-full">{{ selectedOrder()!.items.length }} ítems</span>
            </h4>
            <div class="space-y-3">
              @for (item of selectedOrder()!.items; track $index) {
                <div class="border rounded-lg p-3 flex flex-col gap-3 group hover:border-blue-300 transition-colors bg-white shadow-sm"
                     [class.bg-red-50]="!item.isLinked" [class.border-red-100]="!item.isLinked">
                  
                  <div class="flex justify-between items-start gap-3">
                     <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="font-mono font-bold text-sm text-blue-900 break-all">{{ item.code }}</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1 line-clamp-2">{{ item.description }}</p>
                        
                        <!-- Breakdown Display -->
                        <div class="mt-2 text-[11px] text-gray-500 bg-gray-50 inline-flex items-center px-2 py-1 rounded border border-gray-100">
                            <span class="font-semibold text-gray-700 mr-1">{{ item.quantity }} uds</span>
                            <span class="text-gray-400 mx-1">x</span>
                            <span>{{ item.unitPrice | currency }}</span>
                        </div>
                     </div>
                     
                     <div class="text-right whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-800">{{ item.total | currency }}</div>
                     </div>
                  </div>

                  <!-- Link Status Bar -->
                  <div class="flex items-center justify-between pt-2 border-t border-gray-100/80">
                      @if (item.isLinked) {
                        <span class="text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded-md border border-green-100 flex items-center gap-1.5 w-full">
                          <i class="fas fa-link text-green-500"></i> 
                          <span class="font-medium">BYD: {{ item.linkedBydCode }}</span>
                        </span>
                      } @else {
                        <div class="flex items-center justify-between w-full gap-2">
                            <span class="text-[10px] text-red-500 font-medium flex items-center gap-1">
                              <i class="fas fa-exclamation-circle"></i> Pendiente
                            </span>
                            <button (click)="openLinkModal(item)" class="text-[10px] bg-white border border-gray-300 hover:border-blue-500 hover:text-blue-600 text-gray-600 px-3 py-1 rounded shadow-sm transition-all font-medium">
                               Vincular
                            </button>
                        </div>
                      }
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Log Timeline -->
          <div>
            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Historial de Eventos</h4>
            <div class="relative pl-4 border-l-2 border-gray-100 space-y-6 pb-2">
              @for (log of selectedOrder()!.logs; track $index) {
                <div class="relative">
                  <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full border-2 border-white shadow-sm"
                       [ngClass]="{
                         'bg-yellow-400': log.status === 'Pending',
                         'bg-blue-500': log.status === 'Transmitted',
                         'bg-orange-500': log.status === 'In Process',
                         'bg-red-500': log.status === 'Rejected',
                         'bg-green-500': log.status === 'Completed'
                       }"></div>
                  <p class="text-[10px] text-gray-400 mb-0.5 uppercase font-bold tracking-wide">{{ log.timestamp | date:'short' }}</p>
                  <p class="text-xs text-gray-800 font-medium bg-gray-50 p-2 rounded border border-gray-100 inline-block">{{ log.message }}</p>
                </div>
              }
            </div>
          </div>

        </div>
      } @else {
        <div class="flex-1 flex flex-col items-center justify-center text-gray-300 p-10 text-center">
          <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
             <i class="fas fa-search text-gray-300 text-2xl"></i>
          </div>
          <h4 class="text-gray-400 font-medium mb-1">Detalle de Orden</h4>
          <p class="text-xs max-w-[200px]">Selecciona un folio de la lista para ver el desglose de artículos, precios y estado de vinculación.</p>
        </div>
      }
    </div>
  </div>

  <!-- Quick Link Modal with AI -->
  @if (itemToLink()) {
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col md:flex-row max-h-[90vh]">
        
        <!-- Left: Form -->
        <div class="w-full md:w-1/2 flex flex-col">
           <div class="p-4 bg-gray-900 text-white flex justify-between items-center">
             <h3 class="font-bold text-sm">Vincular Item Dalton</h3>
             <button (click)="closeLinkModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
           </div>
           
           <div class="p-6 flex-1 overflow-y-auto space-y-5">
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                <span class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Item Origen (Dalton)</span>
                <div class="font-mono font-bold text-gray-800 text-lg">{{ itemToLink()!.code }}</div>
                <div class="text-sm text-gray-600 mt-1 leading-snug">{{ itemToLink()!.description }}</div>
             </div>

             <div class="space-y-4">
                <div>
                  <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Código BYD Destino</label>
                  <input type="text" [(ngModel)]="newLinkBydCode" placeholder="Ej: L-99201" 
                    class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium">
                </div>
                
                <div>
                  <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Tipo de Operación</label>
                  <div class="flex gap-3">
                     <button (click)="newLinkType = 'Labor'" class="flex-1 py-2.5 text-sm rounded-lg border transition-all flex items-center justify-center gap-2" 
                       [class]="newLinkType === 'Labor' ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-600 hover:bg-gray-50'">
                       <i class="fas fa-hammer"></i> Labor
                     </button>
                     <button (click)="newLinkType = 'Repair'" class="flex-1 py-2.5 text-sm rounded-lg border transition-all flex items-center justify-center gap-2" 
                       [class]="newLinkType === 'Repair' ? 'bg-purple-600 text-white border-purple-600 shadow-md' : 'bg-white text-gray-600 hover:bg-gray-50'">
                       <i class="fas fa-wrench"></i> Repair
                     </button>
                  </div>
                </div>
             </div>
           </div>
           
           <div class="p-4 border-t border-gray-100 bg-gray-50">
             <button (click)="confirmLink()" [disabled]="!newLinkBydCode" 
               class="w-full py-3 bg-gray-900 hover:bg-black text-white rounded-lg font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-transform active:scale-95">
               Confirmar y Guardar
             </button>
           </div>
        </div>

        <!-- Right: AI Suggestions -->
        <div class="w-full md:w-1/2 bg-gradient-to-br from-slate-50 to-blue-50 border-l border-gray-100 flex flex-col">
          <div class="p-4 border-b border-white/50 flex items-center justify-between">
             <h4 class="font-bold text-gray-800 flex items-center gap-2">
               <i class="fas fa-sparkles text-yellow-500"></i> Sugerencias IA
             </h4>
             <span class="text-[10px] bg-white/80 px-2 py-1 rounded text-gray-500 border border-gray-200">Gemini 2.5</span>
          </div>

          <div class="p-5 flex-1 overflow-y-auto">
             @if (isAiLoading()) {
               <div class="flex flex-col items-center justify-center h-40 text-center space-y-3">
                 <div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                 <p class="text-xs text-blue-600 font-medium animate-pulse">Analizando histórico y patrones...</p>
               </div>
             } @else if (aiSuggestions().length > 0) {
               <div class="space-y-3">
                 @for (sug of aiSuggestions(); track $index) {
                   <button (click)="applySuggestion(sug)" 
                     class="w-full text-left bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:shadow-md hover:border-blue-300 transition-all group relative overflow-hidden">
                     <div class="absolute top-0 left-0 w-1 h-full" 
                       [ngClass]="{
                         'bg-green-500': sug.confidence === 'High',
                         'bg-yellow-500': sug.confidence === 'Medium',
                         'bg-gray-300': sug.confidence === 'Low'
                       }"></div>
                     
                     <div class="flex justify-between items-start mb-1 pl-2">
                        <span class="font-bold text-gray-800 group-hover:text-blue-600 transition-colors">{{ sug.code }}</span>
                        <span class="text-[10px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wide"
                          [ngClass]="sug.type === 'Labor' ? 'bg-blue-50 text-blue-700' : 'bg-purple-50 text-purple-700'">
                          {{ sug.type }}
                        </span>
                     </div>
                     <p class="text-xs text-gray-500 pl-2 leading-relaxed">{{ sug.reasoning }}</p>
                     
                     <div class="mt-2 pl-2 flex items-center gap-1 text-[10px] font-medium"
                        [ngClass]="{
                          'text-green-600': sug.confidence === 'High',
                          'text-yellow-600': sug.confidence === 'Medium',
                          'text-gray-400': sug.confidence === 'Low'
                        }">
                        <i class="fas fa-chart-line"></i> Confianza: {{ sug.confidence }}
                     </div>
                   </button>
                 }
               </div>
             } @else {
               <div class="flex flex-col items-center justify-center h-40 text-center text-gray-400">
                  <i class="fas fa-robot text-3xl mb-2 opacity-20"></i>
                  <p class="text-xs">No se pudieron generar sugerencias.</p>
               </div>
             }
          </div>
          
          <div class="p-3 text-center">
            <p class="text-[10px] text-gray-400 italic">La IA basa sus recomendaciones en patrones históricos.</p>
          </div>
        </div>

      </div>
    </div>
  }

</div>
