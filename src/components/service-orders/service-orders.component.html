
<div class="flex flex-col h-full gap-6 animate-fade-in">
  
  <!-- Filters Section -->
  <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
    <div class="flex flex-col md:flex-row md:items-end gap-4">
      
      <div class="w-full md:w-auto flex-1 min-w-[150px]">
        <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Buscar Folio / Orden</label>
        <div class="relative">
           <input type="text" [ngModel]="searchOrderNumber()" (ngModelChange)="searchOrderNumber.set($event)" 
              placeholder="Ej: XCL00435" 
              class="w-full p-2.5 pl-9 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 outline-none">
           <i class="fas fa-hashtag absolute left-3 top-3 text-gray-400 text-xs"></i>
        </div>
      </div>

      <div class="w-full md:w-auto">
        <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Tipo Orden</label>
        <select [ngModel]="selectedOrderType()" (ngModelChange)="selectedOrderType.set($event)"
           class="w-full md:w-40 p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
           <option value="ALL">Todos</option>
           @for (type of strategyService.supportedTypes(); track type.code) {
             <option [value]="type.code">{{ type.label }}</option>
           }
        </select>
      </div>

      <div class="w-full md:w-auto">
        <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Fecha Inicial</label>
        <input type="date" [(ngModel)]="startDate" class="w-full md:w-40 p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 outline-none [color-scheme:light]">
      </div>
      <div class="w-full md:w-auto">
        <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Fecha Final</label>
        <input type="date" [(ngModel)]="endDate" class="w-full md:w-40 p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-900 focus:ring-2 focus:ring-blue-500 outline-none [color-scheme:light]">
      </div>
      <button (click)="fetchOrders()" [disabled]="isLoading()" 
        class="w-full md:w-auto px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow-md shadow-blue-100 transition-all flex items-center justify-center gap-2 disabled:opacity-50">
        @if (isLoading()) {
          <i class="fas fa-circle-notch fa-spin"></i>
        } @else {
          <i class="fas fa-search"></i> Buscar
        }
      </button>
    </div>
  </div>

  <!-- Content Area: List & Details -->
  <div class="flex flex-col lg:flex-row gap-6 flex-1 min-h-0">
    
    <!-- Order List -->
    <div class="lg:w-7/12 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
      <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
        <h3 class="font-semibold text-gray-800">Listado de Órdenes</h3>
        <span class="text-xs text-gray-500">{{ filteredOrders().length }} resultados</span>
      </div>
      <div class="overflow-auto flex-1">
        <table class="w-full text-left border-collapse">
          <thead class="sticky top-0 bg-white z-10">
            <tr class="text-xs font-semibold text-gray-500 border-b border-gray-100 uppercase tracking-wider">
              <th class="px-4 py-3">Folio / Tipo</th>
              <th class="px-4 py-3">VIN / Modelo</th>
              <th class="px-4 py-3">Cliente</th>
              <th class="px-4 py-3 text-right">Total</th>
              <th class="px-4 py-3 text-center">Status</th>
            </tr>
          </thead>
          <tbody class="text-sm divide-y divide-gray-100">
            @for (order of filteredOrders(); track order.id) {
              <tr class="hover:bg-blue-50/50 cursor-pointer transition-colors" 
                  [class.bg-blue-50]="selectedOrder()?.id === order.id"
                  (click)="selectOrder(order)">
                <td class="px-4 py-3 font-medium text-gray-900">
                   <div class="flex items-center gap-2 mb-1">
                      <!-- Strategy Pattern Badge -->
                      <span class="px-1.5 py-0.5 rounded text-[9px] font-bold flex items-center gap-1"
                         [ngClass]="strategyService.getBadgeClass(order.docType)">
                         <i class="fas {{ strategyService.getStrategy(order.docType).icon }}"></i>
                         {{ order.docType }}
                      </span>
                      <span class="text-xs font-bold">{{ order.orderNumber }}</span>
                   </div>
                   <div class="text-[10px] text-gray-400">{{ order.date }}</div>
                </td>
                <td class="px-4 py-3">
                   <div class="font-mono text-xs text-gray-800 font-bold">{{ order.vin }}</div>
                   <div class="text-[10px] text-blue-600 truncate max-w-[120px]" title="{{order.modelDescRaw}}">
                     {{ order.modelDescRaw || 'Sin Modelo' }}
                   </div>
                </td>
                <td class="px-4 py-3 text-gray-600 truncate max-w-[100px]">{{ order.customerName }}</td>
                <td class="px-4 py-3 text-right font-mono text-gray-700">{{ order.totalAmount | currency }}</td>
                <td class="px-4 py-3 text-center">
                  <span class="px-2 py-1 rounded-full text-[10px] font-bold border uppercase tracking-wide"
                    [ngClass]="getStatusClass(order.status)">
                    {{ order.status }}
                  </span>
                </td>
              </tr>
            }
            @if (filteredOrders().length === 0 && !isLoading()) {
              <tr>
                <td colspan="5" class="px-6 py-12 text-center text-gray-400">
                   <p>No hay órdenes para los filtros seleccionados.</p>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Order Details -->
    <div class="lg:w-5/12 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden relative transition-all duration-300 ease-in-out">
      @if (selectedOrder()) {
        <!-- Details Header with Dynamic Style -->
        <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-start relative overflow-hidden">
           <!-- Color Stripe based on Type -->
           <div class="absolute top-0 left-0 bottom-0 w-1" [ngClass]="'bg-' + strategyService.getStrategy(selectedOrder()!.docType).colorClass + '-500'"></div>
           
           <div>
             <div class="flex items-center gap-2">
                <h3 class="font-bold text-gray-900 text-lg">{{ selectedOrder()!.orderNumber }}</h3>
                <span class="text-[10px] px-2 py-0.5 rounded border font-bold" 
                   [ngClass]="strategyService.getBadgeClass(selectedOrder()!.docType)">
                   {{ strategyService.getStrategy(selectedOrder()!.docType).label }}
                </span>
             </div>
             <p class="text-xs font-mono text-gray-700 mt-1 font-bold">
               VIN: {{ selectedOrder()!.vin }}
             </p>
             <p class="text-xs text-blue-600 font-medium">
               Modelo: {{ selectedOrder()!.modelDescRaw }}
             </p>
           </div>
           <button (click)="closeDetail()" class="text-gray-400 hover:text-gray-600 p-1">
             <i class="fas fa-times"></i>
           </button>
        </div>

        <div class="flex-1 overflow-auto p-5 space-y-6">
          
          <!-- Items List -->
          <div>
            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex justify-between items-center">
                <span>Detalle</span>
                <span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded-full">{{ selectedOrder()!.items.length }} ítems</span>
            </h4>
            <div class="space-y-3">
              @for (item of selectedOrder()!.items; track $index) {
                <div class="border rounded-lg p-3 flex flex-col gap-3 group hover:border-blue-300 transition-colors bg-white shadow-sm"
                     [class.bg-red-50]="!item.isLinked" [class.border-red-100]="!item.isLinked">
                  
                  <div class="flex justify-between items-start gap-3">
                     <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="font-mono font-bold text-sm text-blue-900 break-all">{{ item.code }}</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1 line-clamp-2">{{ item.description }}</p>
                     </div>
                     
                     <div class="text-right whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-800">{{ item.total | currency }}</div>
                     </div>
                  </div>

                  <!-- Link Status Bar -->
                  <div class="flex items-center justify-between pt-2 border-t border-gray-100/80">
                      @if (item.isLinked) {
                        <span class="text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded-md border border-green-100 flex items-center gap-1.5 w-full">
                          <i class="fas fa-link text-green-500"></i> 
                          <span class="font-medium">BYD: {{ item.linkedBydCode }}</span>
                        </span>
                      } @else {
                        <!-- Logic to show link button based on Strategy -->
                        <div class="flex items-center justify-between w-full gap-2">
                            <span class="text-[10px] text-red-500 font-medium flex items-center gap-1">
                              <i class="fas fa-exclamation-circle"></i> Pendiente
                            </span>
                            
                            @if(strategyService.getStrategy(selectedOrder()!.docType).rules.allowLinking) {
                                <button (click)="openLinkModal(item)" class="text-[10px] bg-white border border-gray-300 hover:border-blue-500 hover:text-blue-600 text-gray-600 px-3 py-1 rounded shadow-sm transition-all font-medium">
                                   <i class="fas fa-plug mr-1"></i> Conectar
                                </button>
                            } @else {
                                <span class="text-[9px] text-gray-400 italic">Vinculación restringida</span>
                            }
                        </div>
                      }
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Log Timeline -->
          @if(selectedOrder()!.logs.length > 0) {
            <div>
              <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Errores Recientes</h4>
              <div class="bg-gray-900 rounded-lg p-3 font-mono text-[10px] text-gray-300 space-y-2">
                @for (log of selectedOrder()!.logs; track $index) {
                   <div class="border-l-2 border-red-500 pl-2">
                     <span class="text-red-400 font-bold">{{ log.timestamp | date:'shortTime' }}:</span> 
                     {{ log.message }}
                   </div>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="flex-1 flex flex-col items-center justify-center text-gray-300 p-10 text-center">
          <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
             <i class="fas fa-search text-gray-300 text-2xl"></i>
          </div>
          <h4 class="text-gray-400 font-medium mb-1">Detalle de Orden</h4>
          <p class="text-xs max-w-[200px]">Selecciona un folio de la lista para ver el desglose de artículos.</p>
        </div>
      }
    </div>
  </div>

  <!-- SMART LINKING MODAL (Same as before) -->
  @if (itemToLink()) {
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh]">
        
        <!-- Header -->
        <div class="bg-gray-900 text-white p-4 flex justify-between items-start">
          <div>
             <h3 class="font-bold text-base flex items-center gap-2">
               <i class="fas fa-project-diagram text-blue-400"></i> Asistente de Vinculación
             </h3>
             <div class="mt-2 flex items-center gap-3 text-xs text-gray-400">
                <span class="bg-gray-800 px-2 py-1 rounded border border-gray-700">VIN: <strong class="text-white">{{ selectedOrder()?.vin }}</strong></span>
                <span class="bg-gray-800 px-2 py-1 rounded border border-gray-700">Modelo: <strong class="text-white">{{ selectedOrder()?.modelDescRaw }}</strong></span>
             </div>
          </div>
          <button (click)="closeLinkModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>

        <!-- Context Selector (CRITICAL FOR ERROR PREVENTION) -->
        <div class="bg-yellow-50 p-4 border-b border-yellow-100 flex items-center gap-4">
           <div class="text-yellow-700 text-2xl">
             <i class="fas fa-exclamation-triangle"></i>
           </div>
           <div class="flex-1">
             <label class="block text-xs font-bold text-yellow-800 uppercase mb-1">
               Selecciona la Serie BYD Correcta (Obligatorio)
             </label>
             <p class="text-[10px] text-yellow-700 mb-2">
               Para evitar el error <strong>"vehicle series not match"</strong>, debes seleccionar la serie del catálogo que corresponda al modelo de la orden.
             </p>
             <select [ngModel]="targetBydSeries()" (ngModelChange)="targetBydSeries.set($event)" 
               class="w-full p-2 border border-yellow-300 bg-white rounded-lg text-sm font-bold text-gray-800 outline-none focus:ring-2 focus:ring-yellow-500">
               <option value="" disabled selected>-- Selecciona Serie del Catálogo --</option>
               @for (series of availableBydSeries(); track series) {
                 <option [value]="series">{{ series }}</option>
               }
             </select>
           </div>
        </div>

        <div class="flex flex-1 min-h-0 overflow-hidden">
           
           <!-- Left: Item Info -->
           <div class="w-1/3 bg-gray-50 p-4 border-r border-gray-200 overflow-y-auto">
              <div class="mb-4">
                <span class="text-[10px] uppercase font-bold text-gray-400">Ítem Dalton (Origen)</span>
                <div class="text-lg font-mono font-bold text-gray-800">{{ itemToLink()?.code }}</div>
                <div class="text-sm text-gray-600 mt-1 border-l-4 border-blue-500 pl-2">{{ itemToLink()?.description }}</div>
              </div>

              @if (selectedCandidate()) {
                 <div class="mt-8 bg-green-50 border border-green-200 rounded-xl p-4 shadow-sm animate-fade-in">
                    <div class="flex items-center gap-2 text-green-700 font-bold text-sm mb-2">
                       <i class="fas fa-check-circle"></i> Vinculación Propuesta
                    </div>
                    <div class="text-xs text-gray-500 mb-1">Código BYD:</div>
                    <div class="font-mono text-lg font-bold text-gray-900 mb-2">{{ selectedCandidate()?.bydCode }}</div>
                    <div class="text-xs text-gray-500 mb-1">Descripción BYD:</div>
                    <div class="text-sm text-gray-800 leading-tight">{{ selectedCandidate()?.description }}</div>
                    <div class="mt-3 pt-3 border-t border-green-200 flex justify-between items-center">
                       <span class="text-[10px] px-2 py-1 rounded bg-white border border-green-200 text-green-800 font-bold">{{ selectedCandidate()?.bydType }}</span>
                       <span class="text-[10px] text-gray-500">{{ selectedCandidate()?.standardHours }} hrs</span>
                    </div>
                 </div>
                 <button (click)="confirmLink()" class="w-full mt-4 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition-transform active:scale-95">
                    Confirmar Vinculación
                 </button>
              } @else {
                 <div class="mt-8 text-center text-gray-400">
                    <i class="fas fa-arrow-right text-2xl mb-2"></i>
                    <p class="text-xs">Selecciona un candidato de la lista derecha.</p>
                 </div>
              }
           </div>

           <!-- Right: Search & Candidates -->
           <div class="w-2/3 flex flex-col bg-white">
              <div class="p-3 border-b border-gray-100">
                 <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" 
                      placeholder="Buscar por descripción o código BYD..." 
                      class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                 </div>
              </div>
              
              <div class="flex-1 overflow-y-auto p-0">
                 @if (!targetBydSeries()) {
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 p-10 text-center">
                       <i class="fas fa-car-side text-4xl mb-3 opacity-30"></i>
                       <p class="font-medium text-gray-600">Serie no seleccionada</p>
                       <p class="text-xs mt-1">Debes seleccionar la Serie/Modelo arriba para ver los códigos compatibles.</p>
                    </div>
                 } @else if (filteredCandidates().length === 0) {
                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                       <p>No se encontraron códigos para "{{ targetBydSeries() }}" con ese término.</p>
                    </div>
                 } @else {
                    <table class="w-full text-left border-collapse">
                       <thead class="bg-gray-50 sticky top-0 text-[10px] text-gray-500 font-bold uppercase">
                          <tr>
                             <th class="px-4 py-2">Código</th>
                             <th class="px-4 py-2">Descripción</th>
                             <th class="px-4 py-2 text-center">Tipo</th>
                             <th class="px-4 py-2">Serie</th>
                          </tr>
                       </thead>
                       <tbody class="text-xs divide-y divide-gray-100">
                          @for (cand of filteredCandidates(); track cand.id) {
                             <tr class="hover:bg-blue-50 cursor-pointer transition-colors"
                                [class.bg-blue-100]="selectedCandidate()?.id === cand.id"
                                (click)="selectCandidate(cand)">
                                <td class="px-4 py-2 font-mono font-bold text-blue-700">{{ cand.bydCode }}</td>
                                <td class="px-4 py-2 text-gray-700">{{ cand.description }}</td>
                                <td class="px-4 py-2 text-center">
                                   <span class="px-1.5 py-0.5 rounded text-[9px] font-bold"
                                      [ngClass]="cand.bydType === 'Labor' ? 'bg-blue-200 text-blue-800' : 'bg-purple-200 text-purple-800'">
                                      {{ cand.bydType }}
                                   </span>
                                </td>
                                <td class="px-4 py-2 text-gray-500 truncate max-w-[100px]" title="{{cand.vehicleSeries}}">
                                   {{ cand.vehicleSeries }}
                                </td>
                             </tr>
                          }
                       </tbody>
                    </table>
                 }
              </div>
           </div>

        </div>
      </div>
    </div>
  }

</div>
