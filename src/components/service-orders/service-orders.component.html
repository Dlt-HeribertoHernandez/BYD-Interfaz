
<div class="flex flex-col h-full gap-6 animate-fade-in">
  
  <!-- Filters Section -->
  <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors">
    <div class="flex flex-col md:flex-row md:items-end gap-4">
      
      <div class="w-full md:w-auto flex-1 min-w-[150px]">
        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1">Buscar Folio / Orden</label>
        <div class="relative">
           <input type="text" [ngModel]="searchOrderNumber()" (ngModelChange)="searchOrderNumber.set($event)" 
              placeholder="Ej: XCL00435" 
              class="w-full p-2.5 pl-9 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-800 dark:text-gray-200 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
           <i class="fas fa-hashtag absolute left-3 top-3 text-gray-400 dark:text-gray-500 text-xs"></i>
        </div>
      </div>

      <div class="w-full md:w-auto">
        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1">Tipo Orden</label>
        <select [ngModel]="selectedOrderType()" (ngModelChange)="selectedOrderType.set($event)"
           class="w-full md:w-40 p-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
           <option value="ALL">Todos</option>
           @for (type of strategyService.supportedTypes(); track type.code) {
             <option [value]="type.code">{{ type.label }}</option>
           }
        </select>
      </div>

      <div class="w-full md:w-auto">
        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1">Fecha Inicial</label>
        <input type="date" [(ngModel)]="startDate" class="w-full md:w-40 p-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 outline-none">
      </div>
      <div class="w-full md:w-auto">
        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1">Fecha Final</label>
        <input type="date" [(ngModel)]="endDate" class="w-full md:w-40 p-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 outline-none">
      </div>
      <button (click)="fetchOrders()" [disabled]="isLoading()" 
        class="w-full md:w-auto px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow-md shadow-blue-200 dark:shadow-none transition-all flex items-center justify-center gap-2 disabled:opacity-50">
        @if (isLoading()) {
          <i class="fas fa-circle-notch fa-spin"></i>
        } @else {
          <i class="fas fa-search"></i> Buscar
        }
      </button>
    </div>
  </div>

  <!-- Content Area: List & Details -->
  <div class="flex flex-col lg:flex-row gap-6 flex-1 min-h-0">
    
    <!-- Order List -->
    <div class="lg:w-7/12 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden transition-colors">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50 flex justify-between items-center">
        <h3 class="font-semibold text-gray-700 dark:text-gray-200">Listado de Órdenes</h3>
        <span class="text-xs text-gray-500 dark:text-gray-400">{{ filteredOrders().length }} resultados</span>
      </div>
      <div class="overflow-auto flex-1">
        <table class="w-full text-left border-collapse">
          <thead class="sticky top-0 bg-white dark:bg-gray-800 z-10 shadow-sm">
            <tr class="text-xs font-semibold text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 uppercase tracking-wider">
              <th class="px-4 py-3">Folio / Tipo</th>
              <th class="px-4 py-3">VIN / Modelo</th>
              <th class="px-4 py-3">Cliente</th>
              <th class="px-4 py-3 text-right">Total</th>
              <th class="px-4 py-3 text-center">Status</th>
            </tr>
          </thead>
          <tbody class="text-sm divide-y divide-gray-100 dark:divide-gray-700">
            @for (order of filteredOrders(); track order.id) {
              <tr class="hover:bg-blue-50 dark:hover:bg-blue-900/30 cursor-pointer transition-colors" 
                  [class.bg-blue-50]="selectedOrder()?.id === order.id"
                  [class.dark:bg-blue-900]="selectedOrder()?.id === order.id"
                  [class.dark:bg-opacity-30]="selectedOrder()?.id === order.id"
                  (click)="selectOrder(order)">
                <td class="px-4 py-3 font-medium text-gray-800 dark:text-gray-200">
                   <div class="flex items-center gap-2 mb-1">
                      <!-- Strategy Pattern Badge -->
                      <span class="px-1.5 py-0.5 rounded text-[9px] font-bold flex items-center gap-1 whitespace-nowrap"
                         [ngClass]="strategyService.getBadgeClass(order.docType)">
                         <i class="fas {{ strategyService.getStrategy(order.docType).icon }}"></i>
                         {{ strategyService.getStrategy(order.docType).label }}
                      </span>
                      <span class="text-xs font-bold">{{ order.orderNumber }}</span>
                   </div>
                   <div class="text-[10px] text-gray-400 dark:text-gray-500">{{ order.date }}</div>
                </td>
                <td class="px-4 py-3">
                   <div class="font-mono text-xs text-gray-600 dark:text-gray-300 font-bold">{{ order.vin }}</div>
                   <div class="text-[10px] text-blue-600 dark:text-blue-400 truncate max-w-[120px]" title="{{order.modelDescRaw}}">
                     {{ order.modelDescRaw || 'Sin Modelo' }}
                   </div>
                </td>
                <td class="px-4 py-3 text-gray-500 dark:text-gray-400 truncate max-w-[100px]">{{ order.customerName }}</td>
                <td class="px-4 py-3 text-right font-mono text-gray-700 dark:text-gray-300">{{ order.totalAmount | currency }}</td>
                <td class="px-4 py-3 text-center">
                  <span class="px-2 py-1 rounded-full text-[10px] font-bold border uppercase tracking-wide"
                    [ngClass]="getStatusClass(order.status)">
                    {{ order.status }}
                  </span>
                </td>
              </tr>
            }
            @if (filteredOrders().length === 0 && !isLoading()) {
              <tr>
                <td colspan="5" class="px-6 py-12 text-center text-gray-400 dark:text-gray-500">
                   <p>No hay órdenes para los filtros seleccionados.</p>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Order Details -->
    <div class="lg:w-5/12 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden relative transition-all duration-300 ease-in-out">
      @if (selectedOrder()) {
        <!-- Details Header with Dynamic Style -->
        <div class="p-5 border-b border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 flex justify-between items-start relative overflow-hidden">
           <!-- Color Stripe based on Type -->
           <div class="absolute top-0 left-0 bottom-0 w-1" [ngClass]="'bg-' + strategyService.getStrategy(selectedOrder()!.docType).colorClass + '-500'"></div>
           
           <div>
             <div class="flex items-center gap-2">
                <h3 class="font-bold text-gray-800 dark:text-white text-lg">{{ selectedOrder()!.orderNumber }}</h3>
                <span class="text-[10px] px-2 py-0.5 rounded border font-bold" 
                   [ngClass]="strategyService.getBadgeClass(selectedOrder()!.docType)">
                   {{ strategyService.getStrategy(selectedOrder()!.docType).label }}
                </span>
             </div>
             <p class="text-xs font-mono text-gray-500 dark:text-gray-400 mt-1 font-bold">
               VIN: {{ selectedOrder()!.vin }}
             </p>
             <p class="text-xs text-blue-600 dark:text-blue-400 font-medium">
               Modelo: {{ selectedOrder()!.modelDescRaw }}
             </p>
           </div>
           
           <!-- TRANSMIT BUTTON (NEW) -->
           @if (selectedOrder()!.status === 'Transmitted') {
              <div class="flex flex-col items-end">
                 <span class="text-xs font-bold text-green-600 dark:text-green-400 flex items-center gap-1">
                    <i class="fas fa-check-circle"></i> Transmitida
                 </span>
                 <span class="text-[10px] text-gray-400">Enviado a Planta</span>
              </div>
           } @else {
              <button (click)="transmitOrderToPlant()" [disabled]="isTransmitting() || !canTransmit(selectedOrder()!)"
                 class="px-4 py-2 bg-gray-800 hover:bg-black dark:bg-gray-700 dark:hover:bg-gray-600 border border-gray-700 dark:border-gray-600 text-white text-xs font-bold rounded-lg shadow-lg transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                 @if (isTransmitting()) {
                    <i class="fas fa-circle-notch fa-spin"></i> Enviando...
                 } @else {
                    <i class="fas fa-paper-plane"></i> Transmitir
                 }
              </button>
           }
        </div>

        <div class="flex-1 overflow-auto p-5 space-y-6 bg-gray-50/50 dark:bg-gray-900/50">
          
          <!-- Items List -->
          <div>
            <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-3 flex justify-between items-center">
                <span>Detalle (Labor)</span>
                <span class="text-[10px] bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full text-gray-500 dark:text-gray-300">{{ visibleItems().length }} ítems visibles</span>
            </h4>
            
            @if(visibleItems().length === 0) {
               <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg text-center">
                  <i class="fas fa-filter text-yellow-500 mb-2 text-lg"></i>
                  <p class="text-xs text-yellow-700 dark:text-yellow-400 font-bold">No hay ítems de Mano de Obra</p>
                  <p class="text-[10px] text-yellow-600 dark:text-yellow-500 mt-1">La regla activa ({{ rulesService.activeRule()?.name }}) filtró todos los conceptos.</p>
               </div>
            }

            <div class="space-y-3">
              @for (item of visibleItems(); track $index) {
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex flex-col gap-3 group hover:border-blue-400 dark:hover:border-blue-500 transition-colors shadow-sm"
                     [class.bg-red-50]="!item.isLinked" [class.dark:bg-red-900]="!item.isLinked" [class.dark:bg-opacity-10]="!item.isLinked" 
                     [class.border-red-200]="!item.isLinked" [class.dark:border-red-800]="!item.isLinked">
                  
                  <div class="flex justify-between items-start gap-3">
                     <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="font-mono font-bold text-sm text-blue-700 dark:text-blue-400 break-all">{{ item.code }}</span>
                          <!-- WILDCARD INDICATOR -->
                          @if (rulesService.isPlaceholderCode(item.code)) {
                             <span class="text-[9px] bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 px-1.5 rounded border border-yellow-200 dark:border-yellow-700 font-bold flex items-center gap-1">
                                <i class="fas fa-star"></i> Requerido
                             </span>
                          }
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 line-clamp-2">{{ item.description }}</p>
                     </div>
                     
                     <div class="text-right whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-800 dark:text-gray-200">{{ item.total | currency }}</div>
                     </div>
                  </div>

                  <!-- Link Status Bar -->
                  <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-700">
                      @if (item.isLinked) {
                        <div class="flex flex-col w-full">
                           <span class="text-[10px] bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 px-2 py-1 rounded-md border border-green-100 dark:border-green-800 flex items-center gap-1.5 w-full mb-1">
                             <i class="fas fa-link text-green-500 dark:text-green-400"></i> 
                             <span class="font-medium">BYD: {{ item.linkedBydCode }}</span>
                           </span>
                           @if(item.linkedBydDescription) {
                             <span class="text-[9px] text-gray-400 italic px-1 truncate">{{ item.linkedBydDescription }}</span>
                           }
                        </div>
                      } @else {
                        <!-- Logic to show link button based on Strategy -->
                        <div class="flex items-center justify-between w-full gap-2">
                            <span class="text-[10px] text-red-500 font-medium flex items-center gap-1">
                              <i class="fas fa-exclamation-circle"></i> Pendiente
                            </span>
                            
                            @if(strategyService.getStrategy(selectedOrder()!.docType).rules.allowLinking) {
                                <button (click)="openLinkModal(item)" 
                                   class="text-[10px] px-3 py-1 rounded shadow-sm transition-all font-bold border flex items-center gap-1"
                                   [class]="rulesService.isPlaceholderCode(item.code) ? 'bg-blue-600 text-white border-blue-700 hover:bg-blue-700 animate-pulse-slow' : 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-400'">
                                   <i class="fas fa-plug"></i> 
                                   {{ rulesService.isPlaceholderCode(item.code) ? 'Vincular Ahora' : 'Conectar' }}
                                </button>
                            } @else {
                                <span class="text-[9px] text-gray-400 italic">Vinculación restringida</span>
                            }
                        </div>
                      }
                  </div>
                </div>
              }
            </div>

            <!-- SUMMARY OF HIDDEN ITEMS (PARTS ETC) -->
            @if(hiddenItemsSummary(); as summary) {
              <div class="mt-4 pt-3 border-t border-dashed border-gray-300 dark:border-gray-600">
                 <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                    <div class="flex items-center gap-2">
                       <i class="fas fa-eye-slash"></i>
                       <span>{{ summary.count }} items ocultos (Refacciones/Otros)</span>
                    </div>
                    <span class="font-mono">{{ summary.totalValue | currency }}</span>
                 </div>
                 <p class="text-[10px] text-gray-400 dark:text-gray-500 mt-1 pl-5 truncate">Incluye: {{ summary.sampleNames }}</p>
              </div>
            }
          </div>

          <!-- Log Timeline -->
          @if(selectedOrder()!.logs.length > 0) {
            <div>
              <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-3">Errores Recientes</h4>
              <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 font-mono text-[10px] text-gray-600 dark:text-gray-300 space-y-2">
                @for (log of selectedOrder()!.logs; track $index) {
                   <div class="border-l-2 border-red-400 pl-2">
                     <span class="text-red-600 dark:text-red-400 font-bold">{{ log.timestamp | date:'shortTime' }}:</span> 
                     {{ log.message }}
                   </div>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="flex-1 flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 p-10 text-center">
          <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-4">
             <i class="fas fa-search text-gray-300 dark:text-gray-500 text-2xl"></i>
          </div>
          <h4 class="text-gray-500 dark:text-gray-400 font-medium mb-1">Detalle de Orden</h4>
          <p class="text-xs max-w-[200px]">Selecciona un folio de la lista para ver el desglose de artículos.</p>
        </div>
      }
    </div>
  </div>

  <!-- SMART LINKING MODAL -->
  @if (itemToLink()) {
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh]">
        
        <!-- Header -->
        <div class="bg-gray-900 text-white p-4 flex justify-between items-start">
          <div>
             <h3 class="font-bold text-base flex items-center gap-2">
               <i class="fas fa-project-diagram text-blue-400"></i> Asistente de Vinculación
             </h3>
             <div class="mt-2 flex items-center gap-3 text-xs text-gray-400">
                <span class="bg-gray-800 px-2 py-1 rounded border border-gray-700">VIN: <strong class="text-white">{{ selectedOrder()?.vin }}</strong></span>
                <span class="bg-gray-800 px-2 py-1 rounded border border-gray-700">Modelo: <strong class="text-white">{{ selectedOrder()?.modelDescRaw }}</strong></span>
             </div>
          </div>
          <button (click)="closeLinkModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>

        <!-- Context Selector (CRITICAL FOR ERROR PREVENTION) -->
        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 border-b border-yellow-100 dark:border-yellow-800 flex items-center gap-4">
           <div class="text-yellow-600 dark:text-yellow-500 text-2xl">
             <i class="fas fa-exclamation-triangle"></i>
           </div>
           <div class="flex-1">
             <label class="block text-xs font-bold text-yellow-700 dark:text-yellow-400 uppercase mb-1">
               Selecciona la Serie BYD Correcta (Obligatorio)
             </label>
             <p class="text-[10px] text-yellow-600 dark:text-yellow-500 mb-2">
               Para evitar el error <strong>"vehicle series not match"</strong>, hemos intentado seleccionar el modelo automáticamente.
             </p>
             <select [ngModel]="targetBydSeries()" (ngModelChange)="targetBydSeries.set($event)" 
               class="w-full p-2 border border-yellow-300 dark:border-yellow-700 bg-white dark:bg-gray-700 rounded-lg text-sm font-bold text-gray-800 dark:text-gray-200 outline-none focus:ring-2 focus:ring-yellow-500">
               <option value="" disabled selected>-- Selecciona Serie del Catálogo --</option>
               @for (series of availableBydSeries(); track series) {
                 <option [value]="series">{{ series }}</option>
               }
             </select>
           </div>
        </div>

        <div class="flex flex-1 min-h-0 overflow-hidden">
           
           <!-- Left: Item Info & AI Trigger -->
           <div class="w-1/3 bg-gray-50 dark:bg-gray-700 p-4 border-r border-gray-200 dark:border-gray-600 overflow-y-auto flex flex-col gap-4">
              
              <!-- Dalton Info -->
              <div>
                <span class="text-[10px] uppercase font-bold text-gray-400 dark:text-gray-500">Ítem Dalton (Origen)</span>
                <div class="text-lg font-mono font-bold text-gray-800 dark:text-gray-100">{{ itemToLink()?.code }}</div>
                <div class="text-sm text-gray-600 dark:text-gray-300 mt-1 border-l-4 border-blue-400 pl-2">{{ itemToLink()?.description }}</div>
              </div>

              <!-- AI Action Area -->
              <div class="bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm">
                  <button (click)="analyzeItemWithAi()" [disabled]="isAiAnalyzing()"
                    class="w-full py-2 bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 font-bold rounded-lg transition-colors flex items-center justify-center gap-2 text-xs border border-indigo-100 dark:border-indigo-800">
                    @if(isAiAnalyzing()) {
                      <i class="fas fa-spinner fa-spin"></i> Analizando...
                    } @else {
                      <i class="fas fa-magic"></i> Analizar con IA
                    }
                  </button>
                  
                  @if (aiAnalysis()) {
                    <div class="mt-3 animate-fade-in">
                       <div class="text-[10px] text-gray-500 dark:text-gray-400 font-bold uppercase mb-1">Interpretación (Inglés)</div>
                       <p class="text-xs italic text-gray-600 dark:text-gray-300 bg-gray-50 dark:bg-gray-700 p-2 rounded border border-gray-200 dark:border-gray-600 mb-2">
                         "{{ aiAnalysis()?.translation }}"
                       </p>
                       <div class="flex flex-wrap gap-1">
                         @for (kw of aiAnalysis()?.keywords; track kw) {
                            <span class="px-2 py-0.5 bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 text-[10px] rounded-full font-bold">{{ kw }}</span>
                         }
                       </div>
                    </div>
                  }
              </div>

              <!-- Selection Confirmation -->
              @if (selectedCandidate()) {
                 <div class="mt-auto bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl p-4 shadow-sm animate-fade-in">
                    <div class="flex items-center gap-2 text-green-600 dark:text-green-400 font-bold text-sm mb-2">
                       <i class="fas fa-check-circle"></i> Set de Datos a Vincular
                    </div>
                    
                    <div class="space-y-3">
                       <div>
                          <div class="text-[10px] text-gray-400 dark:text-gray-500 font-bold uppercase">Labour Code</div>
                          <div class="font-mono text-base font-bold text-gray-800 dark:text-gray-200">{{ selectedCandidate()?.bydCode }}</div>
                       </div>
                       
                       <div>
                          <div class="text-[10px] text-gray-400 dark:text-gray-500 font-bold uppercase">Labour Name</div>
                          <div class="text-xs text-gray-600 dark:text-gray-300 leading-tight bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-600">{{ selectedCandidate()?.description }}</div>
                       </div>

                       <div>
                          <div class="text-[10px] text-gray-400 dark:text-gray-500 font-bold uppercase">Labour Amount (Horas)</div>
                          <div class="font-mono text-sm font-bold text-gray-800 dark:text-gray-200">{{ selectedCandidate()?.standardHours || '0.0' }}</div>
                       </div>
                    </div>

                 </div>
                 <button (click)="confirmLink()" class="w-full mt-4 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition-transform active:scale-95">
                    Confirmar y Asignar
                 </button>
              }
           </div>

           <!-- Right: Search & Candidates -->
           <div class="w-2/3 flex flex-col bg-white dark:bg-gray-800">
              <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                 <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <!-- Auto-Filled Search Term -->
                    <input type="text" [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" 
                      placeholder="Buscar por Labour Code o Descripción..." 
                      class="w-full pl-10 pr-4 py-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm text-gray-800 dark:text-gray-200 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 outline-none">
                 </div>
                 <div class="text-[9px] text-gray-400 dark:text-gray-500 mt-1 text-right">
                    @if (searchTerm()) {
                       * Resultados filtrados
                    } @else {
                       * Mostrando catálogo completo de la serie
                    }
                 </div>
              </div>
              
              <div class="flex-1 overflow-y-auto p-0">
                 @if (!targetBydSeries()) {
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 dark:text-gray-500 p-10 text-center">
                       <i class="fas fa-car-side text-4xl mb-3 opacity-20"></i>
                       <p class="font-medium text-gray-500 dark:text-gray-400">Serie no seleccionada</p>
                       <p class="text-xs mt-1">Debes seleccionar la Serie/Modelo arriba para ver los códigos compatibles.</p>
                    </div>
                 } @else {
                    
                    <!-- AI Suggestions Section -->
                    @if (aiSuggestedCandidates().length > 0) {
                       <div class="bg-indigo-50 dark:bg-indigo-900/20 border-b border-indigo-100 dark:border-indigo-800">
                          <div class="px-4 py-2 text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider flex items-center gap-2">
                             <i class="fas fa-robot"></i> Sugerencias IA (Top 12)
                          </div>
                          <table class="w-full text-left border-collapse">
                             <tbody class="text-xs divide-y divide-indigo-100 dark:divide-indigo-800">
                                @for (cand of aiSuggestedCandidates(); track cand.id) {
                                   <tr class="hover:bg-indigo-100 dark:hover:bg-indigo-900/40 cursor-pointer transition-colors"
                                      [class.bg-indigo-200]="selectedCandidate()?.id === cand.id"
                                      [class.dark:bg-indigo-900]="selectedCandidate()?.id === cand.id"
                                      (click)="selectCandidate(cand)">
                                      <td class="px-4 py-2 font-mono font-bold text-indigo-700 dark:text-indigo-300">{{ cand.bydCode }}</td>
                                      <td class="px-4 py-2 text-gray-700 dark:text-gray-300">
                                        {{ cand.description }}
                                      </td>
                                      <!-- NEW: Match Score Indicator -->
                                      <td class="px-4 py-2 text-right">
                                        <div class="flex flex-col items-end">
                                           <span class="text-[9px] font-bold text-white bg-indigo-500 px-1.5 rounded">
                                              {{ cand.matchScore }} pts
                                           </span>
                                           <span class="text-[9px] text-indigo-400 mt-0.5 font-mono">{{ cand.standardHours || '-' }} Hrs</span>
                                        </div>
                                      </td>
                                   </tr>
                                }
                             </tbody>
                          </table>
                       </div>
                    }

                    <!-- Full List -->
                    @if (filteredCandidates().length === 0 && aiSuggestedCandidates().length === 0) {
                        <div class="flex flex-col items-center justify-center h-40 text-gray-400 dark:text-gray-500">
                           <p>No se encontraron códigos para "{{ targetBydSeries() }}".</p>
                        </div>
                    } @else {
                        <table class="w-full text-left border-collapse">
                           <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 text-[10px] text-gray-500 dark:text-gray-400 font-bold uppercase shadow-sm">
                              <tr>
                                 <th class="px-4 py-2">Labour Code</th>
                                 <th class="px-4 py-2">Descripción (Labour Name)</th>
                                 <th class="px-4 py-2 text-center">Horas</th>
                              </tr>
                           </thead>
                           <tbody class="text-xs divide-y divide-gray-100 dark:divide-gray-700">
                              @for (cand of filteredCandidates(); track cand.id) {
                                 <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors"
                                    [class.bg-blue-100]="selectedCandidate()?.id === cand.id"
                                    [class.dark:bg-blue-900]="selectedCandidate()?.id === cand.id"
                                    (click)="selectCandidate(cand)">
                                    <td class="px-4 py-2 font-mono font-bold text-blue-600 dark:text-blue-400">{{ cand.bydCode }}</td>
                                    <td class="px-4 py-2 text-gray-600 dark:text-gray-300">{{ cand.description }}</td>
                                    <td class="px-4 py-2 text-center font-mono text-gray-400 dark:text-gray-500 font-bold">{{ cand.standardHours || '-' }}</td>
                                 </tr>
                              }
                           </tbody>
                        </table>
                    }
                 }
              </div>
           </div>

        </div>
      </div>
    </div>
  }

</div>
