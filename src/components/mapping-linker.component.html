
<div class="flex flex-col h-full gap-4 animate-fade-in">
  
  <!-- Top Bar: Global Search & Upload -->
  <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex justify-between items-center gap-4 transition-colors">
     <div class="flex-1 relative max-w-2xl flex gap-4">
        <div class="relative flex-1">
          <i class="fas fa-search absolute left-3 top-3 text-gray-400 dark:text-gray-500"></i>
          <input type="text" [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" 
             placeholder="Buscar Labour Code, Descripción o Categoría..."
             class="w-full pl-10 pr-4 py-2.5 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:bg-white dark:focus:bg-gray-600 focus:ring-2 focus:ring-blue-500 outline-none transition-all text-gray-800 dark:text-gray-200 placeholder-gray-400">
        </div>
        
        <!-- Toggle Filter -->
        <button (click)="showLinkedOnly.set(!showLinkedOnly())"
           class="px-4 py-2.5 rounded-lg font-bold text-xs uppercase tracking-wide border transition-all flex items-center gap-2"
           [class]="showLinkedOnly() ? 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800' : 'bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600'">
           <i class="fas" [class]="showLinkedOnly() ? 'fa-link' : 'fa-globe'"></i>
           {{ showLinkedOnly() ? 'Solo Vinculados' : 'Todo el Catálogo' }}
        </button>
     </div>
     
     <div class="flex items-center gap-3">
        <!-- Active Rule Indicator -->
        <div class="flex flex-col items-end mr-2">
           <span class="text-[9px] text-gray-400 dark:text-gray-500 uppercase font-bold">Regla de Negocio Activa</span>
           <div class="text-xs font-bold text-purple-600 dark:text-purple-400 flex items-center gap-1">
              <i class="fas fa-brain"></i> {{ rulesService.activeRule()?.name || 'Sin Regla' }}
           </div>
        </div>

        <input type="file" #fileInput (change)="onFileSelected($event)" accept=".xlsx, .xls" class="hidden">
        <button (click)="triggerFileInput()" 
           class="px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-sm transition-all flex items-center gap-2">
           @if (isUploading()) {
              <i class="fas fa-circle-notch fa-spin"></i>
           } @else {
              <i class="fas fa-file-excel"></i> Cargar Catálogo
           }
        </button>
        <button (click)="analyzeWithGemini()" [disabled]="isAnalyzing() || mappings().length === 0"
           class="px-4 py-2.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 border border-indigo-200 dark:border-indigo-800 rounded-lg font-medium transition-all flex items-center gap-2">
           @if (isAnalyzing()) {
              <i class="fas fa-magic fa-spin"></i>
           } @else {
              <i class="fas fa-robot"></i> Auditoría IA
           }
        </button>
     </div>
  </div>

  <!-- AI Result Area -->
  @if (aiAnalysisResult()) {
    <div class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-lg p-4 text-sm text-indigo-800 dark:text-indigo-300 leading-relaxed flex items-start gap-3 animate-fade-in">
       <i class="fas fa-sparkles mt-1 text-indigo-500"></i>
       <div>{{ aiAnalysisResult() }}</div>
    </div>
  }

  <!-- Main Layout -->
  <div class="flex flex-1 min-h-0 gap-4">
    
    <!-- Sidebar: Vehicle Series (Folder Structure) -->
    <div class="w-64 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden shrink-0">
       <div class="p-3 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 font-bold text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">
          Series / Modelos
       </div>
       <div class="overflow-y-auto flex-1 p-2 space-y-1">
          @for (group of seriesGroups(); track group.name) {
             <button (click)="selectSeries(group.name)"
               class="w-full text-left px-3 py-2.5 rounded-lg text-sm flex justify-between items-center group transition-all"
               [class]="selectedSeries() === group.name ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'">
               <span class="truncate font-medium">{{ group.name }}</span>
               <span class="text-[10px] px-2 py-0.5 rounded-full font-bold"
                  [class]="selectedSeries() === group.name ? 'bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-200' : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 group-hover:bg-gray-300 dark:group-hover:bg-gray-500'">
                  {{ group.count }}
               </span>
             </button>
          }
          @if (seriesGroups().length === 0) {
             <div class="p-4 text-center text-gray-400 text-xs">
                Sin datos cargados.
             </div>
          }
       </div>
    </div>

    <!-- Middle: Data Table & Categories -->
    <div class="flex-1 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden min-w-0">
       <!-- Categories Filter Toolbar -->
       <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex gap-2 overflow-x-auto bg-white dark:bg-gray-800 scrollbar-hide items-center">
          <span class="text-xs font-bold text-gray-400 uppercase mr-2 shrink-0"><i class="fas fa-filter"></i> Categorías:</span>
          @for (cat of availableCategories(); track cat) {
             <button (click)="toggleCategory(cat)"
                class="whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium border transition-all"
                [class]="selectedCategory() === cat ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 border-blue-200 dark:border-blue-800' : 'bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600'">
                {{ cat }}
             </button>
          }
       </div>

       <!-- Table -->
       <div class="flex-1 overflow-auto">
          <table class="w-full text-left border-collapse">
             <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10 text-[10px] text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider shadow-sm">
                <tr>
                   <th class="px-4 py-3 border-b border-gray-200 dark:border-gray-600 w-1/3">Catálogo BYD</th>
                   <th class="px-2 py-3 border-b border-gray-200 dark:border-gray-600 text-center w-16">Estatus</th>
                   <th class="px-4 py-3 border-b border-gray-200 dark:border-gray-600 w-1/4">Mapeo Interno (Dalton)</th>
                   <th class="px-4 py-3 border-b border-gray-200 dark:border-gray-600">Descripción</th>
                   <th class="px-4 py-3 border-b border-gray-200 dark:border-gray-600 text-right">Acciones</th>
                </tr>
             </thead>
             <tbody class="text-xs divide-y divide-gray-100 dark:divide-gray-700">
                @for (item of filteredMappings(); track item.id) {
                   <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 group transition-colors">
                      
                      <!-- Col 1: BYD Master Info -->
                      <td class="px-4 py-3 align-top">
                         <div class="font-mono font-bold text-blue-700 dark:text-blue-400 text-sm">{{ item.bydCode }}</div>
                         <div class="text-[10px] text-gray-500 dark:text-gray-400 font-medium mt-0.5">{{ item.vehicleSeries || 'Generico' }}</div>
                      </td>

                      <!-- Col 2: Bridge / Status Visual -->
                      <td class="px-2 py-3 align-middle text-center">
                         @if (item.status === 'Linked' || item.daltonCode !== item.bydCode) {
                            <div class="w-8 h-8 rounded-full bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 flex items-center justify-center text-green-500 dark:text-green-400 mx-auto shadow-sm">
                               <i class="fas fa-link"></i>
                            </div>
                         } @else {
                            <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 flex items-center justify-center text-gray-400 mx-auto">
                               <i class="fas fa-minus"></i>
                            </div>
                         }
                      </td>

                      <!-- Col 3: Internal Dalton Code (The Link) -->
                      <td class="px-4 py-3 align-top">
                         @if (item.daltonCode && item.daltonCode !== item.bydCode) {
                             <div class="font-mono font-bold text-gray-800 dark:text-gray-200 bg-green-50 dark:bg-green-900/30 px-2 py-1 rounded border border-green-100 dark:border-green-800 inline-block">
                                {{ item.daltonCode }}
                             </div>
                             <div class="text-[9px] text-green-600 dark:text-green-400 mt-1 font-medium"><i class="fas fa-check-circle"></i> Vinculado</div>
                         } @else {
                             <div class="font-mono text-gray-400 italic">{{ item.daltonCode || '--' }}</div>
                             <div class="text-[9px] text-gray-400 mt-1">Estándar</div>
                         }
                      </td>

                      <!-- Col 4: Description -->
                      <td class="px-4 py-3 align-top text-gray-600 dark:text-gray-300">
                         <div class="font-medium mb-1">{{ item.description }}</div>
                         @if (item.description === item.bydCode) {
                            <div class="text-[9px] text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 px-1 rounded border border-red-100 dark:border-red-800 inline-block">
                               <i class="fas fa-exclamation-triangle"></i> Posible duplicado de código
                            </div>
                         }
                         <div class="flex gap-2 items-center mt-1">
                           @if (item.subCategory) {
                              <span class="inline-block px-1.5 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 text-[9px] border border-gray-200 dark:border-gray-600">{{ item.subCategory }}</span>
                           }
                           <span class="text-[10px] font-mono text-gray-400">{{ item.standardHours || 0 }} Hrs</span>
                         </div>
                      </td>

                      <td class="px-4 py-3 align-top text-right">
                         <div class="opacity-0 group-hover:opacity-100 transition-opacity flex justify-end gap-2">
                            <button (click)="openLinkToOrdersModal(item)" class="text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900 p-1.5 rounded" title="Vincular a Orden">
                               <i class="fas fa-link"></i>
                            </button>
                            <button (click)="deleteItem(item.id)" class="text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900 p-1.5 rounded" title="Eliminar">
                               <i class="fas fa-trash"></i>
                            </button>
                         </div>
                      </td>
                   </tr>
                }
                @if (filteredMappings().length === 0) {
                   <tr>
                      <td colspan="5" class="px-6 py-12 text-center text-gray-400 dark:text-gray-500">
                         <div class="text-4xl mb-2 opacity-20"><i class="fas fa-folder-open"></i></div>
                         <p>No hay códigos para esta selección.</p>
                      </td>
                   </tr>
                }
             </tbody>
          </table>
       </div>
       <div class="p-2 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 text-xs text-right text-gray-500 dark:text-gray-400">
          Mostrando {{ filteredMappings().length }} registros
       </div>
    </div>

    <!-- Right: Manual Entry (Context Aware) -->
    <div class="w-80 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden shrink-0">
       <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-800 dark:bg-gray-900 text-white">
          <h3 class="font-bold text-sm flex items-center gap-2">
             <i class="fas fa-plus-circle"></i> Registro Manual
          </h3>
          <p class="text-xs text-gray-300 mt-1">Agrega un código faltante a la serie.</p>
       </div>
       
       <form [formGroup]="linkForm" (ngSubmit)="onSubmitManual()" class="flex-1 overflow-y-auto p-4 space-y-4">
          
          <!-- CRITICAL: Series Selector -->
          <div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg border border-yellow-200 dark:border-yellow-800">
             <label class="block text-[10px] font-bold text-yellow-700 dark:text-yellow-400 uppercase mb-1">Serie Vehículo (Requerido)</label>
             <select formControlName="vehicleSeries" 
                class="w-full p-2 bg-white dark:bg-gray-700 border border-yellow-300 dark:border-yellow-600 rounded text-xs font-bold text-gray-800 dark:text-gray-200 outline-none focus:ring-2 focus:ring-yellow-500">
                <option value="" disabled>-- Seleccionar --</option>
                @for (group of seriesGroups(); track group.name) {
                   <option [value]="group.name">{{ group.name }}</option>
                }
             </select>
             <p class="text-[9px] text-yellow-600 dark:text-yellow-500 mt-1 leading-tight">
                <i class="fas fa-info-circle"></i> Debe coincidir con el modelo de la orden.
             </p>
          </div>

          <div>
             <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1">Labour Code (BYD)</label>
             <input type="text" formControlName="bydCode" placeholder="Ej: WSA3..." 
                class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 dark:text-gray-200 placeholder-gray-400">
          </div>

          <div>
             <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1">Código Interno (Opcional)</label>
             <input type="text" formControlName="daltonCode" placeholder="Ej: 12345-00" 
                class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 dark:text-gray-200 placeholder-gray-400">
          </div>

          <div>
             <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1">Labour Name (Descripción)</label>
             <textarea formControlName="description" rows="3" 
                class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm outline-none focus:ring-2 focus:ring-blue-500 resize-none text-gray-800 dark:text-gray-200"></textarea>
          </div>

          <div>
             <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1">Labour Amount (Horas)</label>
             <input type="number" formControlName="standardHours" step="0.1"
                class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 dark:text-gray-200">
          </div>
          
          <button type="submit" [disabled]="linkForm.invalid"
             class="w-full py-2.5 bg-gray-900 hover:bg-black dark:bg-gray-700 dark:hover:bg-gray-600 text-white rounded-lg font-bold text-sm shadow-lg disabled:opacity-50 transition-all mt-2">
             Guardar Registro
          </button>
       </form>
    </div>

  </div>
</div>

<!-- PREVIEW MODAL (Simplified) -->
@if (showPreviewModal()) {
  <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-4 bg-green-600 text-white flex justify-between items-center shrink-0">
         <div>
            <h3 class="font-bold">Vista Previa ({{ previewData().length }} registros)</h3>
            <p class="text-xs text-white/80 mt-0.5">Se aplicó la regla: <strong>{{ rulesService.activeRule()?.name }}</strong></p>
         </div>
         <button (click)="discardUpload()" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
      </div>
      <div class="flex-1 overflow-auto bg-white dark:bg-gray-800">
         <table class="w-full text-left border-collapse">
            <thead class="sticky top-0 bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-300 text-xs uppercase border-b border-green-200 dark:border-green-800">
               <tr>
                  @for(header of previewHeaders(); track header) { <th class="px-4 py-2 whitespace-nowrap">{{ header }}</th> }
               </tr>
            </thead>
            <tbody class="text-xs divide-y divide-gray-100 dark:divide-gray-700">
               @for (row of previewData(); track $index) {
                  <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                     @for(header of previewHeaders(); track header) { 
                        <td class="px-4 py-2 truncate max-w-[200px] text-gray-600 dark:text-gray-300">
                            {{ row[header] }}
                            <!-- WARNING IF DESCRIPTION == CODE -->
                            @if(header === 'description' && row['description'] === row['bydCode'] && row['description'].length > 3) {
                                <span class="block text-[9px] text-red-500 font-bold mt-1 bg-red-50 px-1 rounded border border-red-100 text-center">
                                   <i class="fas fa-exclamation-triangle"></i> Posible error de mapeo
                                </span>
                            }
                        </td> 
                     }
                  </tr>
               }
            </tbody>
         </table>
      </div>
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex justify-end gap-3">
         <button (click)="discardUpload()" class="px-6 py-2 text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 rounded-lg border border-gray-300 dark:border-gray-600 font-bold transition-colors shadow-sm">
            Cancelar
         </button>
         <button (click)="proceedToInsertion()" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-lg transition-colors">
            Confirmar Carga
         </button>
      </div>
    </div>
  </div>
}

<!-- INSERTION CONFIRMATION MODAL -->
@if (showInsertionModal()) {
   <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in">
     <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[80vh]">
       <div class="p-4 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white border-b border-gray-200 dark:border-gray-600">
          <h3 class="font-bold text-blue-600 dark:text-blue-400"><i class="fas fa-database mr-2"></i> Confirmar Carga a Base de Datos</h3>
       </div>
       <div class="p-6 text-center bg-white dark:bg-gray-800">
          <div class="text-4xl text-blue-500 mb-4"><i class="fas fa-cloud-upload-alt"></i></div>
          <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-2">¿Estás listo para procesar {{ insertionData().length }} registros?</h4>
          <p class="text-sm text-gray-500 dark:text-gray-400 max-w-md mx-auto">Esta acción se ejecutará en segundo plano. Recibirás una notificación cuando termine.</p>
       </div>
       <div class="p-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 flex justify-center gap-4">
          <button (click)="cancelInsertion()" class="px-5 py-2 text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 border border-gray-300 dark:border-gray-500 rounded-lg font-medium shadow-sm">Volver</button>
          <button (click)="confirmFinalInsertion()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg">
             Confirmar y Cargar
          </button>
       </div>
     </div>
   </div>
}

<!-- LINK TO ORDER MODAL -->
@if (showLinkToOrderModal()) {
   <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
     <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[80vh]">
        
        <!-- Modal Header with Tabs -->
        <div class="flex flex-col border-b border-gray-200 dark:border-gray-700">
           <div class="p-4 flex justify-between items-center bg-gray-50 dark:bg-gray-700">
              <h3 class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
                 <i class="fas fa-link text-blue-500"></i>
                 Vincular "{{ selectedMappingForLink()?.bydCode }}"
              </h3>
              <button (click)="closeLinkModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-white"><i class="fas fa-times"></i></button>
           </div>
           
           <!-- Tabs -->
           <div class="flex bg-gray-50 dark:bg-gray-700 px-4 gap-4">
              <button (click)="activeLinkModalTab.set('pending')" 
                 class="pb-2 px-2 text-xs font-bold uppercase tracking-wide border-b-2 transition-colors"
                 [class]="activeLinkModalTab() === 'pending' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'">
                 Pendientes
              </button>
              <button (click)="activeLinkModalTab.set('history')" 
                 class="pb-2 px-2 text-xs font-bold uppercase tracking-wide border-b-2 transition-colors"
                 [class]="activeLinkModalTab() === 'history' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'">
                 Historial de Uso
              </button>
           </div>
        </div>

        <!-- CONTENT AREA -->
        <div class="flex-1 overflow-y-auto bg-white dark:bg-gray-800 flex flex-col min-h-[300px]">
           
           <!-- VIEW: PENDING ORDERS -->
           @if (activeLinkModalTab() === 'pending') {
              <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 sticky top-0 z-10">
                 <input type="text" [ngModel]="itemSearchTerm()" (ngModelChange)="updateSearch($event)" 
                    placeholder="Buscar en órdenes pendientes..." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 focus:bg-white dark:focus:bg-gray-600 outline-none text-gray-800 dark:text-gray-200 placeholder-gray-400">
              </div>
              
              <div class="flex-1 p-2">
                 @for (item of filteredPendingItems(); track item.code + item.orderRef) {
                    <label class="flex items-start gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded cursor-pointer border border-transparent hover:border-gray-200 dark:hover:border-gray-600 transition-colors">
                       <input type="checkbox" (change)="toggleOrderItemSelection(item.code, $event)" class="mt-1 text-blue-600 focus:ring-blue-500 bg-white dark:bg-gray-600 border-gray-300 dark:border-gray-500 rounded">
                       <div class="flex-1">
                          <div class="flex justify-between">
                             <span class="font-bold text-xs text-gray-800 dark:text-gray-200">{{ item.code }}</span>
                             <span class="text-[10px] bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-1.5 rounded">{{ item.orderRef }}</span>
                          </div>
                          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ item.description }}</p>
                       </div>
                    </label>
                 }
                 @if (filteredPendingItems().length === 0) {
                    <div class="p-8 text-center text-gray-400 text-xs">
                       No se encontraron ítems pendientes.
                    </div>
                 }
              </div>
              
              <!-- Footer Action for Pending -->
              <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-700 sticky bottom-0">
                 <span class="text-xs text-gray-500 dark:text-gray-400">{{ selectedOrderItemsToLink().size }} seleccionados</span>
                 <button (click)="confirmBulkLink()" [disabled]="selectedOrderItemsToLink().size === 0" 
                    class="px-4 py-2 bg-blue-600 text-white rounded font-bold text-sm disabled:opacity-50 shadow-md hover:bg-blue-700">Vincular</button>
              </div>
           } 
           
           <!-- VIEW: HISTORY -->
           @else if (activeLinkModalTab() === 'history') {
              <div class="flex-1 p-4">
                 @if (isLoadingHistory()) {
                    <div class="flex justify-center items-center h-32 text-gray-400">
                       <i class="fas fa-circle-notch fa-spin text-2xl"></i>
                    </div>
                 } @else if (usageHistory().length === 0) {
                    <div class="flex flex-col justify-center items-center h-48 text-gray-400 dark:text-gray-500">
                       <i class="fas fa-history text-3xl mb-2 opacity-30"></i>
                       <p class="text-xs">No hay historial de uso para este código.</p>
                    </div>
                 } @else {
                    <div class="space-y-3">
                       @for (record of usageHistory(); track $index) {
                          <div class="flex gap-3 p-3 rounded-lg border border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                             <div class="w-10 h-10 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 shrink-0">
                                <i class="fas fa-file-invoice"></i>
                             </div>
                             <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                   <span class="font-bold text-sm text-gray-800 dark:text-gray-200">{{ record.orderRef }}</span>
                                   <span class="text-[10px] text-gray-400 font-mono">{{ record.date }}</span>
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 font-mono mt-0.5">VIN: {{ record.vin }}</div>
                                <p class="text-xs text-gray-600 dark:text-gray-300 mt-1 line-clamp-1 bg-gray-50 dark:bg-gray-900/50 p-1 rounded">{{ record.description }}</p>
                             </div>
                          </div>
                       }
                    </div>
                 }
              </div>
           }

        </div>
     </div>
   </div>
}
