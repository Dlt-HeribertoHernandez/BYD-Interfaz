
<div class="flex flex-col h-full gap-4 animate-fade-in">
  
  <!-- Top Bar: Global Search & Upload -->
  <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center gap-4">
     <div class="flex-1 relative max-w-2xl">
        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        <input type="text" [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" 
           placeholder="Buscar código, descripción o categoría en la serie seleccionada..."
           class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all text-gray-800">
     </div>
     
     <div class="flex items-center gap-3">
        <input type="file" #fileInput (change)="onFileSelected($event)" accept=".xlsx, .xls" class="hidden">
        <button (click)="triggerFileInput()" 
           class="px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium shadow-sm transition-all flex items-center gap-2">
           @if (isUploading()) {
              <i class="fas fa-circle-notch fa-spin"></i>
           } @else {
              <i class="fas fa-file-excel"></i> Cargar Catálogo
           }
        </button>
        <button (click)="analyzeWithGemini()" [disabled]="isAnalyzing() || mappings().length === 0"
           class="px-4 py-2.5 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-200 rounded-lg font-medium transition-all flex items-center gap-2">
           @if (isAnalyzing()) {
              <i class="fas fa-magic fa-spin"></i>
           } @else {
              <i class="fas fa-robot"></i> Auditoría IA
           }
        </button>
     </div>
  </div>

  <!-- AI Result Area -->
  @if (aiAnalysisResult()) {
    <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 text-sm text-indigo-800 leading-relaxed flex items-start gap-3 animate-fade-in">
       <i class="fas fa-sparkles mt-1 text-indigo-500"></i>
       <div>{{ aiAnalysisResult() }}</div>
    </div>
  }

  <!-- Main Layout -->
  <div class="flex flex-1 min-h-0 gap-4">
    
    <!-- Sidebar: Vehicle Series (Folder Structure) -->
    <div class="w-64 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden shrink-0">
       <div class="p-3 bg-gray-50 border-b border-gray-100 font-bold text-xs text-gray-500 uppercase tracking-wider">
          Series / Modelos
       </div>
       <div class="overflow-y-auto flex-1 p-2 space-y-1">
          @for (group of seriesGroups(); track group.name) {
             <button (click)="selectSeries(group.name)"
               class="w-full text-left px-3 py-2.5 rounded-lg text-sm flex justify-between items-center group transition-all"
               [class]="selectedSeries() === group.name ? 'bg-blue-600 text-white shadow-md shadow-blue-200' : 'text-gray-600 hover:bg-gray-100'">
               <span class="truncate font-medium">{{ group.name }}</span>
               <span class="text-[10px] px-2 py-0.5 rounded-full font-bold"
                  [class]="selectedSeries() === group.name ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-500 group-hover:bg-white'">
                  {{ group.count }}
               </span>
             </button>
          }
          @if (seriesGroups().length === 0) {
             <div class="p-4 text-center text-gray-400 text-xs">
                Sin datos cargados.
             </div>
          }
       </div>
    </div>

    <!-- Middle: Data Table & Categories -->
    <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden min-w-0">
       <!-- Categories Filter Toolbar -->
       <div class="p-3 border-b border-gray-100 flex gap-2 overflow-x-auto bg-white scrollbar-hide items-center">
          <span class="text-xs font-bold text-gray-400 uppercase mr-2 shrink-0"><i class="fas fa-filter"></i> Categorías:</span>
          @for (cat of availableCategories(); track cat) {
             <button (click)="toggleCategory(cat)"
                class="whitespace-nowrap px-3 py-1 rounded-full text-xs font-medium border transition-all"
                [class]="selectedCategory() === cat ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100'">
                {{ cat }}
             </button>
          }
       </div>

       <!-- Table -->
       <div class="flex-1 overflow-auto">
          <table class="w-full text-left border-collapse">
             <thead class="bg-gray-50 sticky top-0 z-10 text-[10px] text-gray-500 font-bold uppercase tracking-wider">
                <tr>
                   <th class="px-4 py-3 border-b border-gray-100">Código Reparación (BYD)</th>
                   <th class="px-4 py-3 border-b border-gray-100">Descripción</th>
                   <th class="px-4 py-3 border-b border-gray-100 text-center">Tipo</th>
                   <th class="px-4 py-3 border-b border-gray-100 text-center">Horas</th>
                   <th class="px-4 py-3 border-b border-gray-100 text-right">Acciones</th>
                </tr>
             </thead>
             <tbody class="text-xs divide-y divide-gray-100">
                @for (item of filteredMappings(); track item.id) {
                   <tr class="hover:bg-blue-50/50 group transition-colors">
                      <td class="px-4 py-2.5 align-top font-mono font-bold text-blue-700">
                         {{ item.bydCode }}
                         <div class="text-[10px] text-gray-400 font-sans font-normal mt-0.5">Ref: {{ item.daltonCode }}</div>
                      </td>
                      <td class="px-4 py-2.5 align-top text-gray-700">
                         <div class="font-medium mb-0.5">{{ item.description }}</div>
                         @if (item.subCategory) {
                            <span class="inline-block px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 text-[9px]">{{ item.subCategory }}</span>
                         }
                      </td>
                      <td class="px-4 py-2.5 align-top text-center">
                         <span class="px-2 py-0.5 rounded text-[10px] font-bold"
                            [ngClass]="item.bydType === 'Labor' ? 'bg-blue-50 text-blue-600' : 'bg-purple-50 text-purple-600'">
                            {{ item.bydType }}
                         </span>
                      </td>
                      <td class="px-4 py-2.5 align-top text-center font-mono text-gray-600">
                         {{ item.standardHours || '-' }}
                      </td>
                      <td class="px-4 py-2.5 align-top text-right">
                         <div class="opacity-0 group-hover:opacity-100 transition-opacity flex justify-end gap-2">
                            <button (click)="openLinkToOrdersModal(item)" class="text-blue-600 hover:bg-blue-100 p-1.5 rounded" title="Vincular a Orden">
                               <i class="fas fa-link"></i>
                            </button>
                            <button (click)="deleteItem(item.id)" class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-1.5 rounded" title="Eliminar">
                               <i class="fas fa-trash"></i>
                            </button>
                         </div>
                      </td>
                   </tr>
                }
                @if (filteredMappings().length === 0) {
                   <tr>
                      <td colspan="5" class="px-6 py-12 text-center text-gray-400">
                         <div class="text-4xl mb-2 opacity-20"><i class="fas fa-folder-open"></i></div>
                         <p>No hay códigos para esta selección.</p>
                      </td>
                   </tr>
                }
             </tbody>
          </table>
       </div>
       <div class="p-2 bg-gray-50 border-t border-gray-100 text-xs text-right text-gray-500">
          Mostrando {{ filteredMappings().length }} registros
       </div>
    </div>

    <!-- Right: Manual Entry (Context Aware) -->
    <div class="w-80 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col overflow-hidden shrink-0">
       <div class="p-4 border-b border-gray-100 bg-gray-900 text-white">
          <h3 class="font-bold text-sm flex items-center gap-2">
             <i class="fas fa-plus-circle"></i> Registro Manual
          </h3>
          <p class="text-xs text-gray-400 mt-1">Agrega un código faltante a la serie.</p>
       </div>
       
       <form [formGroup]="linkForm" (ngSubmit)="onSubmitManual()" class="flex-1 overflow-y-auto p-4 space-y-4">
          
          <!-- CRITICAL: Series Selector -->
          <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100">
             <label class="block text-[10px] font-bold text-yellow-800 uppercase mb-1">Serie Vehículo (Requerido)</label>
             <select formControlName="vehicleSeries" 
                class="w-full p-2 bg-white border border-yellow-200 rounded text-xs font-bold text-gray-800 outline-none focus:ring-2 focus:ring-yellow-400">
                <option value="" disabled>-- Seleccionar --</option>
                @for (group of seriesGroups(); track group.name) {
                   <option [value]="group.name">{{ group.name }}</option>
                }
             </select>
             <p class="text-[9px] text-yellow-700 mt-1 leading-tight">
                <i class="fas fa-info-circle"></i> Debe coincidir con el modelo de la orden para evitar errores de integración.
             </p>
          </div>

          <div>
             <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Tipo</label>
             <div class="grid grid-cols-2 gap-2">
                <button type="button" (click)="linkForm.patchValue({bydType: 'Labor'})"
                   class="py-1.5 text-xs rounded border text-center transition-colors"
                   [class]="linkForm.get('bydType')?.value === 'Labor' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 hover:bg-gray-50'">
                   Labor
                </button>
                <button type="button" (click)="linkForm.patchValue({bydType: 'Repair'})"
                   class="py-1.5 text-xs rounded border text-center transition-colors"
                   [class]="linkForm.get('bydType')?.value === 'Repair' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-gray-600 hover:bg-gray-50'">
                   Repair
                </button>
             </div>
          </div>

          <div>
             <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Código BYD</label>
             <input type="text" formControlName="bydCode" placeholder="Ej: WSA3..." 
                class="w-full p-2 bg-gray-50 border border-gray-200 rounded text-sm font-mono outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
          </div>

          <div>
             <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Código Dalton</label>
             <input type="text" formControlName="daltonCode" placeholder="Ej: 12345-00" 
                class="w-full p-2 bg-gray-50 border border-gray-200 rounded text-sm outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
          </div>

          <div>
             <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Descripción</label>
             <textarea formControlName="description" rows="3" 
                class="w-full p-2 bg-gray-50 border border-gray-200 rounded text-sm outline-none focus:ring-2 focus:ring-blue-500 resize-none text-gray-800"></textarea>
          </div>
          
          <button type="submit" [disabled]="linkForm.invalid"
             class="w-full py-2.5 bg-gray-900 hover:bg-black text-white rounded-lg font-bold text-sm shadow-lg disabled:opacity-50 transition-all mt-2">
             Guardar Registro
          </button>
       </form>
    </div>

  </div>
</div>

<!-- PREVIEW MODAL -->
@if (showPreviewModal()) {
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-4 bg-green-600 text-white flex justify-between items-center shrink-0">
         <h3 class="font-bold">Vista Previa ({{ previewData().length }} registros)</h3>
         <button (click)="discardUpload()" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
      </div>
      <div class="flex-1 overflow-auto bg-white">
         <table class="w-full text-left border-collapse">
            <thead class="sticky top-0 bg-green-500 text-white text-xs uppercase">
               <tr>
                  @for(header of previewHeaders(); track header) { <th class="px-4 py-2 whitespace-nowrap">{{ header }}</th> }
               </tr>
            </thead>
            <tbody class="text-xs divide-y divide-gray-100">
               @for (row of previewData(); track $index) {
                  <tr class="hover:bg-gray-50">
                     @for(header of previewHeaders(); track header) { 
                        <td class="px-4 py-2 truncate max-w-[200px] text-gray-700 border-b border-gray-50">{{ row[header] }}</td> 
                     }
                  </tr>
               }
            </tbody>
         </table>
      </div>
      <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
         <button (click)="discardUpload()" class="px-6 py-2 text-gray-700 bg-white hover:bg-gray-100 rounded-lg border border-gray-300 font-bold transition-colors shadow-sm">
            Cancelar
         </button>
         <button (click)="proceedToInsertion()" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-lg transition-colors">
            Siguiente
         </button>
      </div>
    </div>
  </div>
}

<!-- INSERTION CONFIRMATION MODAL -->
@if (showInsertionModal()) {
   <div class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in">
     <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[80vh]">
       <div class="p-4 bg-gray-800 text-white border-b border-gray-700">
          <h3 class="font-bold text-blue-400"><i class="fas fa-database mr-2"></i> Confirmar Carga a Base de Datos</h3>
       </div>
       <div class="p-6 text-center bg-white">
          <div class="text-4xl text-blue-600 mb-4"><i class="fas fa-cloud-upload-alt"></i></div>
          <h4 class="text-lg font-bold text-gray-800 mb-2">¿Estás listo para procesar {{ insertionData().length }} registros?</h4>
          <p class="text-sm text-gray-500 max-w-md mx-auto">Esta acción se ejecutará en segundo plano. Recibirás una notificación cuando termine.</p>
       </div>
       <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-center gap-4">
          <button (click)="cancelInsertion()" class="px-5 py-2 text-gray-700 bg-white hover:bg-gray-100 border border-gray-300 rounded-lg font-medium shadow-sm">Volver</button>
          <button (click)="confirmFinalInsertion()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg">
             Confirmar y Cargar
          </button>
       </div>
     </div>
   </div>
}

<!-- LINK TO ORDER MODAL -->
@if (showLinkToOrderModal()) {
   <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
     <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[80vh]">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50">
           <h3 class="font-bold text-gray-800">Vincular "{{ selectedMappingForLink()?.bydCode }}"</h3>
           <button (click)="closeLinkModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 border-b bg-white">
           <input type="text" [ngModel]="itemSearchTerm()" (ngModelChange)="updateSearch($event)" 
              placeholder="Buscar en órdenes pendientes..." class="w-full p-2 border rounded bg-gray-50 focus:bg-white outline-none text-gray-800">
        </div>
        <div class="flex-1 overflow-y-auto p-2 bg-white">
           @for (item of filteredPendingItems(); track item.code + item.orderRef) {
              <label class="flex items-start gap-3 p-3 hover:bg-blue-50 rounded cursor-pointer border border-transparent hover:border-blue-100">
                 <input type="checkbox" (change)="toggleOrderItemSelection(item.code, $event)" class="mt-1 text-blue-600 focus:ring-blue-500">
                 <div class="flex-1">
                    <div class="flex justify-between">
                       <span class="font-bold text-xs text-gray-800">{{ item.code }}</span>
                       <span class="text-[10px] bg-gray-200 text-gray-700 px-1.5 rounded">{{ item.orderRef }}</span>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">{{ item.description }}</p>
                 </div>
              </label>
           }
        </div>
        <div class="p-4 border-t flex justify-between items-center bg-gray-50">
           <span class="text-xs text-gray-500">{{ selectedOrderItemsToLink().size }} seleccionados</span>
           <button (click)="confirmBulkLink()" [disabled]="selectedOrderItemsToLink().size === 0" 
              class="px-4 py-2 bg-blue-600 text-white rounded font-bold text-sm disabled:opacity-50 shadow-md">Vincular</button>
        </div>
     </div>
   </div>
}
