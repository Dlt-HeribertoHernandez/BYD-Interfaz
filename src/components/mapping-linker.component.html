
<div class="flex flex-col h-full gap-6 animate-fade-in">

  <!-- SECTION 1: KPI & AI DASHBOARD -->
  <!-- High-level overview of the catalog health -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
     <!-- Stat 1: Total -->
     <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm flex items-center gap-4 relative overflow-hidden">
        <div class="w-12 h-12 rounded-full bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center text-blue-600 dark:text-blue-400 text-xl">
           <i class="fas fa-database"></i>
        </div>
        <div>
           <div class="text-2xl font-bold text-gray-800 dark:text-white">{{ kpiStats().total }}</div>
           <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Códigos Maestros</div>
        </div>
        <!-- Decoration -->
        <i class="fas fa-database absolute -right-4 -bottom-4 text-6xl text-gray-50 dark:text-gray-700/30 -z-0 transform rotate-12"></i>
     </div>

     <!-- Stat 2: Coverage/Health -->
     <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm flex items-center gap-4">
        <div class="relative w-12 h-12 flex items-center justify-center">
           <svg class="w-full h-full transform -rotate-90 text-gray-200 dark:text-gray-700" viewBox="0 0 36 36">
              <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" />
              <path [attr.stroke-dasharray]="kpiStats().healthScore + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#10B981" stroke-width="3" />
           </svg>
           <span class="absolute text-[10px] font-bold text-gray-700 dark:text-gray-300">{{ kpiStats().healthScore }}%</span>
        </div>
        <div>
           <div class="text-sm font-bold text-gray-800 dark:text-white">Calidad Catálogo</div>
           <div class="text-xs text-gray-500">Items categorizados y descritos</div>
        </div>
     </div>

     <!-- Stat 3: Distribution -->
     <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm flex flex-col justify-center">
        <div class="flex justify-between text-xs mb-1">
           <span class="text-gray-500"><i class="fas fa-wrench text-orange-500 mr-1"></i> Labor</span>
           <span class="font-bold dark:text-white">{{ kpiStats().laborCount }}</span>
        </div>
        <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1.5 mb-2 overflow-hidden">
           <div class="bg-orange-500 h-1.5 rounded-full" [style.width.%]="(kpiStats().laborCount / kpiStats().total) * 100"></div>
        </div>
        <div class="flex justify-between text-xs mb-1">
           <span class="text-gray-500"><i class="fas fa-cogs text-purple-500 mr-1"></i> Repair (Parts)</span>
           <span class="font-bold dark:text-white">{{ kpiStats().repairCount }}</span>
        </div>
        <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1.5 overflow-hidden">
           <div class="bg-purple-500 h-1.5 rounded-full" [style.width.%]="(kpiStats().repairCount / kpiStats().total) * 100"></div>
        </div>
     </div>

     <!-- Action: AI Boost -->
     <button (click)="runAiNormalization()" [disabled]="isAnalyzing()"
        class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-xl p-4 text-white shadow-lg shadow-indigo-500/30 flex flex-col items-center justify-center gap-2 hover:scale-[1.02] transition-transform active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed group relative overflow-hidden">
        
        <!-- Animated background effect -->
        <div class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform duration-500 skew-y-12"></div>
        
        @if (isAnalyzing()) {
           <i class="fas fa-circle-notch fa-spin text-2xl"></i>
           <span class="text-xs font-bold tracking-widest animate-pulse">PROCESANDO...</span>
        } @else {
           <i class="fas fa-wand-magic-sparkles text-2xl group-hover:rotate-12 transition-transform"></i>
           <div class="text-center">
              <div class="font-bold text-sm">Normalizar Catálogo</div>
              <div class="text-[10px] text-white/80">Usar IA Gemini</div>
           </div>
        }
     </button>
  </div>

  <!-- SECTION 2: WORKSTATION (Filters | Grid | Inspector) -->
  <div class="flex flex-col lg:flex-row flex-1 min-h-0 gap-4">
     
     <!-- LEFT: FILTERS & TOOLS -->
     <div class="lg:w-64 flex flex-col gap-4 shrink-0">
        
        <!-- Import Box -->
        <div (click)="triggerFileInput()"
             class="bg-white dark:bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-all group">
           <input type="file" id="hiddenFileInput" hidden (change)="onFileSelected($event)" accept=".json,.csv">
           <div class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-2 group-hover:bg-blue-100 group-hover:text-blue-600 transition-colors">
              <i class="fas fa-cloud-upload-alt text-gray-400 dark:text-gray-500 group-hover:text-blue-600"></i>
           </div>
           <span class="text-xs font-bold text-gray-600 dark:text-gray-300 block">Importar Data</span>
           <span class="text-[10px] text-gray-400 block mt-1">JSON o CSV</span>
        </div>

        <!-- Filters Panel -->
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl flex flex-col flex-1 overflow-hidden">
           <div class="p-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
              <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider"><i class="fas fa-filter mr-1"></i> Filtros</h3>
           </div>
           
           <div class="p-3 space-y-4 overflow-y-auto flex-1">
              <!-- Series Filter -->
              <div>
                 <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Serie / Modelo</label>
                 <select [ngModel]="filterSeries()" (ngModelChange)="filterSeries.set($event)" 
                    class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded text-xs font-bold text-gray-700 dark:text-gray-200 outline-none">
                    <option [value]="null">Todas las Series</option>
                    @for(series of facets().series; track series) {
                       <option [value]="series">{{ series }}</option>
                    }
                 </select>
              </div>

              <!-- Category Filter -->
              <div>
                 <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Sistema / Categoría</label>
                 <div class="space-y-1">
                    <button (click)="filterCategory.set(null)" 
                       class="w-full text-left px-2 py-1.5 rounded text-xs flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700"
                       [class.font-bold]="!filterCategory()"
                       [class.text-blue-600]="!filterCategory()">
                       <div class="w-2 h-2 rounded-full bg-gray-400"></div> Todos
                    </button>
                    @for(cat of facets().categories; track cat) {
                       <button (click)="filterCategory.set(cat)" 
                          class="w-full text-left px-2 py-1.5 rounded text-xs flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                          [class]="filterCategory() === cat ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 font-bold' : 'text-gray-600 dark:text-gray-400'">
                          <i class="fas w-4 text-center text-[10px]" [class]="getCategoryIcon(cat)"></i> {{ cat }}
                       </button>
                    }
                 </div>
              </div>
           </div>
        </div>
     </div>

     <!-- MIDDLE: SMART GRID -->
     <div class="flex-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl flex flex-col overflow-hidden shadow-sm">
        
        <!-- Grid Toolbar -->
        <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between gap-4 bg-white dark:bg-gray-800">
           <div class="relative flex-1 max-w-md">
              <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
              <input type="text" [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)"
                 placeholder="Buscar código, descripción..." 
                 class="w-full pl-9 pr-4 py-2 bg-gray-100 dark:bg-gray-700 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:text-white">
           </div>
           <div class="text-xs text-gray-500 dark:text-gray-400 font-mono">
              {{ filteredGridData().length }} Items
           </div>
        </div>

        <!-- Grid Content -->
        <div class="flex-1 overflow-auto bg-gray-50 dark:bg-gray-900/50">
           <table class="w-full text-left border-collapse">
              <thead class="sticky top-0 bg-gray-100 dark:bg-gray-800 text-[10px] text-gray-500 uppercase tracking-wider border-b border-gray-200 dark:border-gray-700 z-10">
                 <tr>
                    <th class="px-4 py-3">BYD Code (Factory)</th>
                    <th class="px-4 py-3">Descripción & Categoría</th>
                    <th class="px-4 py-3">DMS (Interno)</th>
                 </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 dark:divide-gray-700 text-sm">
                 @for (item of filteredGridData(); track item.id) {
                    <tr (click)="selectItem(item)" 
                        class="cursor-pointer transition-colors group hover:bg-white dark:hover:bg-gray-700"
                        [class]="selectedItemId() === item.id ? 'bg-blue-50 dark:bg-blue-900/20' : ''">
                       
                       <!-- Col 1: BYD Code -->
                       <td class="px-4 py-3 align-top">
                          <div class="font-mono font-bold text-blue-700 dark:text-blue-400 group-hover:text-blue-600">{{ item.bydCode }}</div>
                          <span class="text-[10px] font-bold bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 px-1.5 py-0.5 rounded mt-1 inline-block">
                             {{ item.vehicleSeries || 'GEN' }}
                          </span>
                       </td>

                       <!-- Col 2: Description -->
                       <td class="px-4 py-3 align-top">
                          <div class="text-gray-800 dark:text-gray-200 font-medium line-clamp-2">{{ item.description }}</div>
                          <div class="flex items-center gap-2 mt-1.5">
                             <span class="text-[10px] px-2 py-0.5 rounded border flex items-center gap-1"
                                [ngClass]="getCategoryColor(item.mainCategory || 'General')">
                                <i class="fas" [class]="getCategoryIcon(item.mainCategory || 'General')"></i>
                                {{ item.mainCategory || 'General' }}
                             </span>
                             <span class="text-[10px] text-gray-400 flex items-center gap-1">
                                <i class="far fa-clock"></i> {{ item.standardHours }}h
                             </span>
                          </div>
                       </td>

                       <!-- Col 3: Dalton Code -->
                       <td class="px-4 py-3 align-top">
                          <div class="font-mono text-gray-500 dark:text-gray-400 text-xs">{{ item.daltonCode }}</div>
                          <div class="text-[10px] text-gray-400 uppercase mt-1">{{ item.bydType }}</div>
                       </td>
                    </tr>
                 }
                 @if(filteredGridData().length === 0) {
                    <tr>
                       <td colspan="3" class="p-10 text-center text-gray-400">
                          <div class="text-4xl mb-2 opacity-30"><i class="fas fa-search"></i></div>
                          <p>No se encontraron registros.</p>
                       </td>
                    </tr>
                 }
              </tbody>
           </table>
        </div>
     </div>

     <!-- RIGHT: INSPECTOR / EDITOR -->
     <div class="lg:w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg flex flex-col shrink-0 overflow-hidden transition-all duration-300"
          [class.w-0]="!isEditing() && !selectedItemId()"
          [class.opacity-0]="!isEditing() && !selectedItemId()"
          [class.lg:w-0]="!isEditing() && !selectedItemId()">
        
        <!-- Header -->
        <div class="p-4 bg-gray-900 text-white flex justify-between items-center">
           <span class="font-bold text-sm"><i class="fas fa-edit mr-2"></i> Inspector</span>
           <div class="flex gap-2">
               @if(selectedItemId()) {
                  <button (click)="deleteCurrentItem()" class="text-red-400 hover:text-red-300 transition-colors" title="Eliminar"><i class="fas fa-trash"></i></button>
               }
               <button (click)="resetSelection()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
           </div>
        </div>

        <!-- Form -->
        <form [formGroup]="itemForm" (ngSubmit)="saveItem()" class="flex-1 overflow-y-auto p-5 space-y-5">
           
           <!-- Vehicle Selector -->
           <div class="bg-blue-50 dark:bg-blue-900/10 p-3 rounded-lg border border-blue-100 dark:border-blue-800">
              <label class="block text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase mb-1">Vehículo Objetivo</label>
              <div class="relative">
                 <i class="fas fa-car absolute left-3 top-2.5 text-blue-400"></i>
                 <input type="text" formControlName="vehicleSeries" placeholder="Ej. SEAL, DOLPHIN" list="seriesList"
                    class="w-full pl-9 pr-3 py-2 bg-white dark:bg-gray-700 border border-blue-200 dark:border-blue-700 rounded-md text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white">
                 <datalist id="seriesList">
                    @for(s of facets().series; track s) { <option [value]="s"></option> }
                 </datalist>
              </div>
           </div>

           <!-- Codes Section -->
           <div class="grid grid-cols-2 gap-3">
              <div>
                 <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">BYD Code</label>
                 <input type="text" formControlName="bydCode" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono dark:text-white uppercase">
              </div>
              <div>
                 <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Internal Code</label>
                 <input type="text" formControlName="daltonCode" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono dark:text-white uppercase">
              </div>
           </div>

           <!-- Description -->
           <div>
              <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Descripción Oficial</label>
              <textarea formControlName="description" rows="3" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm dark:text-white resize-none"></textarea>
           </div>

           <!-- Meta Data -->
           <div class="grid grid-cols-2 gap-3">
              <div>
                 <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Categoría</label>
                 <select formControlName="mainCategory" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm dark:text-white">
                    @for(cat of facets().categories; track cat) { <option [value]="cat">{{ cat }}</option> }
                 </select>
              </div>
              <div>
                 <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Hrs Std.</label>
                 <input type="number" step="0.1" formControlName="standardHours" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm dark:text-white">
              </div>
           </div>
           
           <div>
              <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Tipo Operación</label>
              <div class="flex gap-2">
                 <label class="flex-1 cursor-pointer">
                    <input type="radio" formControlName="bydType" value="Labor" class="peer sr-only">
                    <div class="text-center py-2 rounded border border-gray-200 dark:border-gray-600 text-xs font-bold text-gray-500 peer-checked:bg-orange-50 peer-checked:text-orange-600 peer-checked:border-orange-500 transition-all">
                       Labor
                    </div>
                 </label>
                 <label class="flex-1 cursor-pointer">
                    <input type="radio" formControlName="bydType" value="Repair" class="peer sr-only">
                    <div class="text-center py-2 rounded border border-gray-200 dark:border-gray-600 text-xs font-bold text-gray-500 peer-checked:bg-purple-50 peer-checked:text-purple-600 peer-checked:border-purple-500 transition-all">
                       Repair
                    </div>
                 </label>
              </div>
           </div>

        </form>

        <!-- Footer Actions -->
        <div class="p-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600">
           <button (click)="saveItem()" [disabled]="itemForm.invalid"
              class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg transform hover:translate-y-[-1px] transition-all disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-save mr-2"></i> {{ itemForm.value.id ? 'Actualizar' : 'Guardar Nuevo' }}
           </button>
        </div>
     </div>

     <!-- FLOAT BUTTON: ADD NEW (Visible when inspector is closed or creating) -->
     @if (!isEditing() && !selectedItemId()) {
        <button (click)="createNew()" 
           class="fixed bottom-8 right-8 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center text-2xl hover:scale-110 transition-transform z-50 animate-bounce-in">
           <i class="fas fa-plus"></i>
        </button>
     }

  </div>

</div>
