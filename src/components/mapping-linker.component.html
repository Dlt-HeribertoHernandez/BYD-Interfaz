
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 relative">
  
  <!-- LEFT COLUMN: Actions (Manual & Upload) -->
  <div class="lg:col-span-1 space-y-6">
    
    <!-- Manual Entry Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="p-5 border-b border-gray-100 bg-gray-50">
        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
          <i class="fas fa-link text-blue-600"></i> Vinculación Manual
        </h3>
      </div>
      <div class="p-5">
        <form [formGroup]="linkForm" (ngSubmit)="onSubmitManual()" class="space-y-4">
          
          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Tipo Código BYD</label>
            <div class="grid grid-cols-2 gap-2">
              <button type="button" 
                class="py-2 px-3 text-sm rounded-lg border transition-colors duration-200"
                [class]="linkForm.get('bydType')?.value === 'Labor' ? 'bg-blue-50 border-blue-500 text-blue-700 font-medium' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'"
                (click)="linkForm.patchValue({bydType: 'Labor'})">
                <i class="fas fa-hammer mr-1"></i> Labor
              </button>
              <button type="button" 
                class="py-2 px-3 text-sm rounded-lg border transition-colors duration-200"
                [class]="linkForm.get('bydType')?.value === 'Repair' ? 'bg-purple-50 border-purple-500 text-purple-700 font-medium' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'"
                (click)="linkForm.patchValue({bydType: 'Repair'})">
                <i class="fas fa-wrench mr-1"></i> Repair
              </button>
            </div>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Código BYD</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                <i class="fas fa-barcode"></i>
              </span>
              <input type="text" formControlName="bydCode" placeholder="Ej: L-90210" 
                class="w-full pl-9 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm">
            </div>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Código Daltonsoft</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                <i class="fas fa-file-invoice"></i>
              </span>
              <input type="text" formControlName="daltonCode" placeholder="Ej: ORD-5501" 
                class="w-full pl-9 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm">
            </div>
          </div>
          
          <div>
             <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Descripción (Opcional)</label>
             <textarea formControlName="description" rows="2" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"></textarea>
          </div>

          <button type="submit" [disabled]="linkForm.invalid" 
            class="w-full py-3 bg-gray-900 hover:bg-black text-white rounded-lg font-medium shadow-lg shadow-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95">
            <i class="fas fa-plus mr-1"></i> Agregar Vinculación
          </button>
        </form>
      </div>
    </div>

    <!-- Upload Card -->
    <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl shadow-lg text-white overflow-hidden relative">
      <div class="absolute top-0 right-0 p-4 opacity-10">
        <i class="fas fa-file-excel text-6xl"></i>
      </div>
      <div class="p-6">
        <h3 class="font-bold text-lg mb-2">Carga Masiva BYD</h3>
        <p class="text-blue-100 text-sm mb-4">Soporta formato oficial: Vehicle code, Project Series, Repair item code, Standard labor hours, etc.</p>
        
        <input type="file" #fileInput (change)="onFileSelected($event)" accept=".xlsx, .xls" class="hidden">
        
        <button (click)="triggerFileInput()" 
          class="w-full py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm border border-white/30 rounded-lg font-medium transition-all flex items-center justify-center gap-2">
          @if (isUploading()) {
             <i class="fas fa-circle-notch fa-spin"></i> Procesando...
          } @else {
             <i class="fas fa-cloud-upload-alt"></i> Cargar Excel Oficial
          }
        </button>
      </div>
    </div>

    <!-- Stats Card -->
     <div class="grid grid-cols-2 gap-4">
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
           <div class="text-2xl font-bold text-blue-600">{{ stats().labor }}</div>
           <div class="text-xs text-gray-500 uppercase font-medium mt-1">Labor Codes</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
           <div class="text-2xl font-bold text-purple-600">{{ stats().repair }}</div>
           <div class="text-xs text-gray-500 uppercase font-medium mt-1">Repair Codes</div>
        </div>
     </div>

  </div>

  <!-- RIGHT COLUMN: Data Table & AI -->
  <div class="lg:col-span-2 flex flex-col h-full">
    
    <!-- AI Analysis Section -->
    <div class="mb-6">
       <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
          <div class="flex justify-between items-start mb-3">
             <div>
                <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                  <i class="fas fa-robot text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-500"></i> 
                  Asistente IA
                </h3>
                <p class="text-sm text-gray-500 mt-1">Auditoría inteligente de datos vinculados.</p>
             </div>
             <button (click)="analyzeWithGemini()" [disabled]="isAnalyzing() || mappings().length === 0"
                class="text-xs font-medium bg-gray-50 hover:bg-gray-100 text-gray-700 py-2 px-3 rounded-lg border border-gray-200 transition-colors flex items-center gap-2 disabled:opacity-50">
                @if (isAnalyzing()) {
                   <i class="fas fa-sparkles fa-spin text-yellow-500"></i> Analizando...
                } @else {
                   <i class="fas fa-magic text-yellow-500"></i> Analizar Datos
                }
             </button>
          </div>

          @if (aiAnalysisResult()) {
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 text-sm text-blue-800 leading-relaxed animate-fade-in">
               <div class="font-semibold mb-1 flex items-center gap-2">
                 <i class="fas fa-check-circle"></i> Resultado del análisis:
               </div>
               {{ aiAnalysisResult() }}
            </div>
          }
       </div>
    </div>

    <!-- Table Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex-1 flex flex-col overflow-hidden">
      <!-- Header & Filters -->
      <div class="p-4 border-b border-gray-100 bg-gray-50 space-y-3">
        <div class="flex justify-between items-center">
          <h3 class="font-semibold text-gray-800">Base de Conocimiento (Master Data)</h3>
          <span class="bg-gray-200 text-gray-700 text-xs font-bold px-2 py-1 rounded-full">{{ filteredMappings().length }} registros</span>
        </div>
        
        <!-- Filters Toolbar -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
           <div>
             <select [ngModel]="filterModel()" (ngModelChange)="filterModel.set($event)" 
               class="w-full h-9 text-sm border border-gray-200 rounded-lg bg-white px-3 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
               <option value="">Todos los Modelos</option>
               @for(model of uniqueModels(); track model) {
                 <option [value]="model">{{ model }}</option>
               }
             </select>
           </div>
           <div>
             <select [ngModel]="filterSeries()" (ngModelChange)="filterSeries.set($event)"
               class="w-full h-9 text-sm border border-gray-200 rounded-lg bg-white px-3 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
               <option value="">Todas las Series/Versiones</option>
               @for(ser of uniqueSeries(); track ser) {
                 <option [value]="ser">{{ ser }}</option>
               }
             </select>
           </div>
           <div>
             <select [ngModel]="filterYear()" (ngModelChange)="filterYear.set($event)"
               class="w-full h-9 text-sm border border-gray-200 rounded-lg bg-white px-3 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
               <option value="">Todos los Años</option>
               <option value="2023">2023</option>
               <option value="2024">2024</option>
               <option value="2025">2025</option>
             </select>
           </div>
        </div>
      </div>
      
      <div class="overflow-x-auto flex-1">
        <table class="w-full text-left border-collapse min-w-[1000px]">
          <thead>
            <tr class="text-[10px] font-bold text-gray-500 bg-gray-50 uppercase tracking-wider sticky top-0 z-10">
              <th class="px-3 py-3 border-b border-gray-100 whitespace-nowrap">Vehicle / Series</th>
              <th class="px-3 py-3 border-b border-gray-100 whitespace-nowrap">Repair Code</th>
              <th class="px-3 py-3 border-b border-gray-100 whitespace-nowrap">Claim Code</th>
              <th class="px-3 py-3 border-b border-gray-100 min-w-[200px]">Repair Item Name</th>
              <th class="px-3 py-3 border-b border-gray-100 whitespace-nowrap">Main Category</th>
              <th class="px-3 py-3 border-b border-gray-100 whitespace-nowrap">Secondary Class</th>
              <th class="px-3 py-3 border-b border-gray-100 text-center whitespace-nowrap">Std Hours</th>
              <th class="px-3 py-3 border-b border-gray-100 text-center whitespace-nowrap">Disp Hours</th>
              <th class="px-3 py-3 border-b border-gray-100 text-center whitespace-nowrap">Battery?</th>
              <th class="px-3 py-3 border-b border-gray-100 text-right whitespace-nowrap sticky right-0 bg-gray-50">Acciones</th>
            </tr>
          </thead>
          <tbody class="text-xs divide-y divide-gray-100">
            @for (item of filteredMappings(); track item.id) {
              <tr class="hover:bg-gray-50 transition-colors group">
                <!-- Vehicle Info -->
                <td class="px-3 py-2 align-middle whitespace-nowrap">
                  <div class="font-bold text-gray-800">{{ item.vehicleModel || '-' }}</div>
                  <div class="text-[10px] text-gray-500">{{ item.vehicleSeries }}</div>
                </td>
                
                <!-- BYD Code -->
                <td class="px-3 py-2 align-middle font-mono text-blue-700 font-medium whitespace-nowrap">
                   {{ item.bydCode }}
                </td>

                <!-- Claim Code -->
                <td class="px-3 py-2 align-middle font-mono text-gray-600 whitespace-nowrap">
                   {{ item.daltonCode }}
                </td>

                <!-- Description -->
                <td class="px-3 py-2 align-middle text-gray-700 font-medium">
                  {{ item.description || '-' }}
                </td>

                <!-- Main Category -->
                <td class="px-3 py-2 align-middle whitespace-nowrap">
                   <span class="px-2 py-0.5 rounded-full text-[10px] bg-blue-50 text-blue-700 border border-blue-100">
                      {{ item.mainCategory || '-' }}
                   </span>
                </td>

                <!-- Sub Category -->
                <td class="px-3 py-2 align-middle whitespace-nowrap">
                   @if(item.subCategory) {
                      <span class="px-2 py-0.5 rounded-full text-[10px] bg-gray-100 text-gray-600">
                         {{ item.subCategory }}
                      </span>
                   } @else {
                      <span class="text-gray-300">-</span>
                   }
                </td>

                <!-- Std Hours -->
                <td class="px-3 py-2 text-center align-middle">
                   @if(item.standardHours) {
                     <span class="font-mono font-bold text-gray-700">{{ item.standardHours }} h</span>
                   } @else {
                     <span class="text-gray-300">-</span>
                   }
                </td>

                <!-- Disp Hours -->
                <td class="px-3 py-2 text-center align-middle">
                   @if(item.dispatchHours) {
                     <span class="font-mono text-gray-600">{{ item.dispatchHours }} h</span>
                   } @else {
                     <span class="text-gray-300">-</span>
                   }
                </td>

                <!-- Battery -->
                <td class="px-3 py-2 text-center align-middle">
                    @if(item.isBatteryRepair) {
                       <i class="fas fa-check text-green-500" title="Yes"></i>
                    } @else {
                       <span class="text-gray-300">-</span>
                    }
                </td>

                <!-- Actions -->
                <td class="px-3 py-2 text-right align-middle sticky right-0 bg-white group-hover:bg-gray-50">
                  <div class="flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                     <button (click)="openLinkToOrdersModal(item)" 
                       class="text-blue-600 bg-blue-50 hover:bg-blue-100 p-1.5 rounded transition-colors" title="Asignar a Orden">
                       <i class="fas fa-clipboard-list"></i>
                     </button>
                     <button (click)="deleteItem(item.id)" 
                       class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-1.5 rounded transition-colors" title="Eliminar">
                       <i class="fas fa-trash-alt"></i>
                     </button>
                  </div>
                </td>
              </tr>
            }
            @if (filteredMappings().length === 0) {
               <tr>
                 <td colspan="10" class="px-6 py-12 text-center text-gray-400">
                    <i class="fas fa-filter text-3xl mb-3 block opacity-20"></i>
                    No se encontraron registros con los filtros actuales.
                 </td>
               </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- SENDING ANIMATION OVERLAY -->
  @if (isSending()) {
    <div class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[100] flex flex-col items-center justify-center animate-fade-in">
      
      <!-- Stylized Loader -->
      <div class="relative w-24 h-24 mb-8">
        <div class="absolute inset-0 border-4 border-gray-200 rounded-full"></div>
        <div class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
        <div class="absolute inset-0 flex items-center justify-center">
           <i class="fas fa-database text-blue-600 text-3xl animate-pulse"></i>
        </div>
      </div>

      <h2 class="text-2xl font-bold text-gray-900 mb-2">Procesando Inserción SQL</h2>
      <p class="text-gray-500 text-sm mb-6">Enviando paquetes de datos al servidor...</p>

      <div class="flex gap-2">
        <span class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
        <span class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
        <span class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
      </div>
    </div>
  }
</div>

<!-- LINK TO ORDER MODAL -->
@if (showLinkToOrderModal()) {
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[85vh]">
      
      <!-- Header -->
      <div class="p-4 bg-gray-900 text-white flex justify-between items-center shrink-0">
        <div>
          <h3 class="font-bold text-sm">Vincular a Órdenes de Servicio</h3>
          <p class="text-xs text-gray-400 mt-0.5">Asignando código maestro BYD a ítems pendientes.</p>
        </div>
        <button (click)="closeLinkModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
      </div>

      <!-- Master Item Info -->
      <div class="bg-blue-50 p-4 border-b border-blue-100 shrink-0 flex gap-4 items-center">
         <div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center text-lg font-bold shrink-0">
           <i class="fas" [class]="selectedMappingForLink()?.bydType === 'Labor' ? 'fa-hammer' : 'fa-wrench'"></i>
         </div>
         <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2">
              <span class="font-bold text-gray-900">{{ selectedMappingForLink()?.bydCode }}</span>
              <span class="text-[10px] px-2 py-0.5 rounded-full bg-white border border-blue-200 text-blue-700 font-medium">
                {{ selectedMappingForLink()?.bydType }}
              </span>
            </div>
            <p class="text-xs text-gray-600 truncate mt-1">{{ selectedMappingForLink()?.description }}</p>
         </div>
      </div>

      <!-- Search Pending Items -->
      <div class="p-4 border-b border-gray-100 shrink-0">
        <div class="relative">
          <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" [ngModel]="itemSearchTerm()" (ngModelChange)="updateSearch($event)" 
            placeholder="Buscar ítem en órdenes pendientes (descripción, código o folio)..." 
            class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-sm">
        </div>
      </div>

      <!-- List -->
      <div class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50/50">
         @if (filteredPendingItems().length > 0) {
            @for (item of filteredPendingItems(); track item.code + item.orderRef) {
               <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-start gap-3 hover:border-blue-300 transition-colors">
                 <div class="pt-1">
                   <input type="checkbox" (change)="toggleOrderItemSelection(item.code, $event)" 
                     class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                 </div>
                 <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start">
                       <span class="font-mono text-xs font-bold text-gray-800">{{ item.code }}</span>
                       <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 rounded">{{ item.orderRef }}</span>
                    </div>
                    <p class="text-xs text-gray-600 mt-0.5 line-clamp-2">{{ item.description }}</p>
                    <p class="text-[10px] text-gray-400 mt-1">Cliente: {{ item.customerRef }}</p>
                 </div>
               </div>
            }
         } @else {
            <div class="text-center py-8 text-gray-400">
               <i class="fas fa-box-open text-3xl mb-2 opacity-20"></i>
               <p class="text-xs">No se encontraron ítems pendientes coincidentes.</p>
            </div>
         }
      </div>

      <!-- Footer Actions -->
      <div class="p-4 border-t border-gray-100 bg-white shrink-0 flex justify-between items-center">
         <span class="text-xs text-gray-500">
            {{ selectedOrderItemsToLink().size }} ítems seleccionados
         </span>
         <button (click)="confirmBulkLink()" 
           [disabled]="selectedOrderItemsToLink().size === 0 || isProcessingLink()"
           class="bg-gray-900 hover:bg-black text-white px-6 py-2.5 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-gray-200">
           @if (isProcessingLink()) {
             <i class="fas fa-circle-notch fa-spin mr-1"></i> Procesando...
           } @else {
             Confirmar Vinculación
           }
         </button>
      </div>

    </div>
  </div>
}

<!-- STEP 1: UPLOAD RAW PREVIEW MODAL -->
@if (showPreviewModal()) {
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[90vh]">
      
      <!-- Header -->
      <div class="p-4 bg-orange-600 text-white flex justify-between items-center shrink-0">
        <div>
          <h3 class="font-bold text-base">Vista Previa de Importación (Paso 1/2)</h3>
          <p class="text-xs text-orange-100 mt-0.5">Datos originales del archivo Excel ({{ previewData().length }} registros detectados).</p>
        </div>
        <button (click)="discardUpload()" class="text-orange-200 hover:text-white"><i class="fas fa-times"></i></button>
      </div>

      <!-- Warning Bar -->
      <div class="bg-orange-50 p-3 text-orange-800 text-xs border-b border-orange-100 flex items-center gap-2 shrink-0">
         <i class="fas fa-info-circle"></i>
         Verifique que los encabezados correspondan a la estructura oficial.
      </div>

      <!-- Table Preview (Raw Data) -->
      <div class="flex-1 overflow-auto">
        <table class="w-full text-left border-collapse">
          <thead class="sticky top-0 bg-orange-500 z-10 text-[11px] uppercase text-white font-bold">
             <tr>
               @for(header of previewHeaders(); track header) {
                  <th class="px-4 py-3 border-b border-orange-400 whitespace-nowrap bg-orange-500">{{ header }}</th>
               }
             </tr>
          </thead>
          <tbody class="text-sm divide-y divide-gray-100">
             @for (row of previewData(); track $index) {
                <tr class="hover:bg-orange-50/30 transition-colors">
                   @for(header of previewHeaders(); track header) {
                      <td class="px-4 py-2 text-xs text-gray-600 border-b border-gray-50 truncate max-w-[200px]" [title]="row[header]">
                         {{ row[header] }}
                      </td>
                   }
                </tr>
             }
          </tbody>
        </table>
      </div>

      <!-- Footer -->
      <div class="p-4 border-t border-gray-100 bg-white shrink-0 flex justify-end items-center gap-3">
         <button (click)="discardUpload()" 
           class="px-5 py-2.5 bg-white text-gray-600 hover:bg-gray-50 border border-gray-300 rounded-lg font-medium transition-colors text-sm">
           Cancelar
         </button>
         <button (click)="proceedToInsertion()" 
           class="px-5 py-2.5 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium shadow-md shadow-orange-200 transition-all flex items-center gap-2 text-sm">
           Siguiente: Validar Inserción <i class="fas fa-arrow-right"></i>
         </button>
      </div>
    </div>
  </div>
}

<!-- STEP 2: SQL INSERTION PREVIEW MODAL ([dbo].[BYDModelosDMS]) -->
@if (showInsertionModal()) {
  <div class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[85vh] border border-gray-700">
      
      <!-- SQL Header -->
      <div class="p-4 bg-gray-800 text-white flex justify-between items-center shrink-0 border-b border-gray-700">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-gray-700 rounded-lg text-blue-400">
             <i class="fas fa-database"></i>
          </div>
          <div>
             <h3 class="font-bold text-base font-mono text-blue-400">INSERT INTO [dbo].[BYDModelosDMS]</h3>
             <p class="text-xs text-gray-400 mt-0.5">Confirmación de estructura de base de datos.</p>
          </div>
        </div>
        <button (click)="cancelInsertion()" class="text-gray-400 hover:text-white transition-colors"><i class="fas fa-times"></i></button>
      </div>

      <!-- Schema Info -->
      <div class="bg-gray-900 p-3 text-gray-300 text-xs font-mono border-b border-gray-800 flex items-center justify-between shrink-0">
         <div>
           <span class="text-gray-500">Schema:</span> dbo &nbsp;|&nbsp; 
           <span class="text-gray-500">Table:</span> BYDModelosDMS &nbsp;|&nbsp; 
           <span class="text-gray-500">Rows:</span> {{ insertionData().length }}
         </div>
         <div class="text-[10px] bg-gray-800 px-2 py-1 rounded text-gray-400">
           Preview Mode
         </div>
      </div>

      <!-- SQL Table Preview -->
      <div class="flex-1 overflow-auto bg-gray-50">
        <table class="w-full text-left border-collapse">
          <thead class="sticky top-0 bg-gray-200 z-10 text-xs uppercase text-gray-700 font-bold shadow-sm">
             <tr>
               <th class="px-4 py-3 border-b border-gray-300 w-16 text-center">[IdModeloVehiculo]</th>
               <th class="px-4 py-3 border-b border-gray-300">[Nombre]</th>
               <th class="px-4 py-3 border-b border-gray-300">[Codigo]</th>
               <th class="px-4 py-3 border-b border-gray-300">[Descripcion]</th>
             </tr>
          </thead>
          <tbody class="text-sm divide-y divide-gray-200 bg-white">
             @for (row of insertionData(); track row.IdModeloVehiculo) {
                <tr class="hover:bg-blue-50 transition-colors font-mono text-xs">
                   <td class="px-4 py-2 text-center text-gray-400 italic">{{ row.IdModeloVehiculo }}</td>
                   <td class="px-4 py-2 text-gray-800 font-semibold">{{ row.Nombre }}</td>
                   <td class="px-4 py-2 text-blue-700">{{ row.Codigo }}</td>
                   <td class="px-4 py-2 text-gray-600">{{ row.Descripcion }}</td>
                </tr>
             }
          </tbody>
        </table>
      </div>

      <!-- Footer Actions -->
      <div class="p-4 border-t border-gray-200 bg-gray-50 shrink-0 flex justify-between items-center">
         <div class="flex gap-2">
           <button (click)="cancelInsertion()" 
             class="text-sm text-gray-500 hover:text-gray-800 underline px-3">
             <i class="fas fa-arrow-left"></i> Volver
           </button>
           
           <!-- JSON Preview Button -->
           <button (click)="generateJsonPreview()"
             class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium text-xs flex items-center gap-2 transition-colors">
             <i class="fas fa-code"></i> Ver JSON
           </button>
         </div>
         
         <button (click)="confirmFinalInsertion()" 
           class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg shadow-blue-200 transition-all flex items-center gap-2 text-sm">
           <i class="fas fa-check-circle"></i> Ejecutar Inserción SQL
         </button>
      </div>
    </div>
  </div>
}

<!-- JSON PAYLOAD PREVIEW MODAL -->
@if (showJsonPreview()) {
  <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-fade-in">
    <div class="bg-[#1e1e1e] rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[80vh] border border-gray-700">
      <div class="p-3 border-b border-gray-700 flex justify-between items-center">
        <span class="text-xs text-gray-400 font-mono">payload.json</span>
        <button (click)="closeJsonPreview()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
      </div>
      <div class="flex-1 overflow-auto p-4">
        <pre class="text-xs font-mono text-green-400 whitespace-pre-wrap">{{ jsonPayloadPreview() }}</pre>
      </div>
    </div>
  </div>
}
