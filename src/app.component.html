
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex flex-col font-sans relative text-gray-800 dark:text-gray-100 transition-colors duration-300">
  
  <!-- GLOBAL CONTEXT SWITCHING OVERLAY -->
  @if(isContextSwitching()) {
    <div class="fixed inset-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md z-[100] flex flex-col items-center justify-center animate-fade-in cursor-wait">
      <div class="relative mb-4">
         <div class="w-16 h-16 border-4 border-gray-200 dark:border-gray-700 border-t-blue-600 rounded-full animate-spin"></div>
         <div class="absolute inset-0 flex items-center justify-center text-blue-600">
            <i class="fas fa-building"></i>
         </div>
      </div>
      <h2 class="text-xl font-bold text-gray-800 dark:text-white">Cambiando Agencia...</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Cargando configuración para <span class="font-bold text-blue-600 dark:text-blue-400">{{ targetDealerName() }}</span></p>
    </div>
  }

  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30 shadow-sm transition-colors duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
      
      <!-- Logo & Title -->
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-md">
          BD
        </div>
        <div class="hidden sm:block">
          <h1 class="text-lg font-bold text-gray-900 dark:text-white leading-tight">LinkMaster</h1>
          <p class="text-[10px] font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">BYD &bull; Daltonsoft</p>
        </div>
      </div>
      
      <!-- Central Context Selector (Dealer) -->
      <div class="flex-1 max-w-2xl mx-4 flex items-center justify-center">
        <div class="relative w-full max-w-[500px]">
           <label class="absolute -top-2 left-3 bg-white dark:bg-gray-800 px-1 text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider z-10 transition-colors">
             Agencia Seleccionada
           </label>
           <select [value]="apiService.selectedDealerCode()" (change)="onDealerChange($event)" [disabled]="isContextSwitching()"
             class="w-full h-11 pl-4 pr-8 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl text-sm font-bold text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 outline-none appearance-none cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors shadow-sm disabled:opacity-60 disabled:cursor-not-allowed">
             <option value="" disabled selected>Seleccionar Agencia de Trabajo</option>
             @for (dealer of dealers(); track dealer.dealerCode) {
               <option [value]="dealer.dealerCode">
                 {{ dealer.dealerCode }} - {{ dealer.dealerName }}
               </option>
             }
           </select>
           
           <!-- Loading Icon inside select area -->
           <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
             @if(isContextSwitching()) {
                <i class="fas fa-circle-notch fa-spin text-blue-500"></i>
             } @else {
                <i class="fas fa-building text-gray-400 dark:text-gray-500 text-xs"></i>
             }
           </div>
        </div>
      </div>

      <!-- Controls & Profile -->
      <div class="flex items-center gap-3">
        
        <!-- Theme Toggle -->
        <button (click)="themeService.toggle()" 
          class="flex items-center justify-center w-9 h-9 rounded-full transition-all border border-transparent hover:border-gray-200 dark:hover:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-yellow-400"
          title="Cambiar Tema">
           @if (themeService.isDark()) {
             <i class="fas fa-sun text-lg"></i>
           } @else {
             <i class="fas fa-moon text-lg"></i>
           }
        </button>

        <!-- Mock Toggle (Compact) -->
        <button (click)="apiService.toggleMockData()" 
          class="hidden md:flex items-center justify-center w-8 h-8 rounded-full transition-colors border ml-1"
          [class]="apiService.useMockData() ? 'bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-500 border-amber-200 dark:border-amber-800' : 'bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-500 border-emerald-200 dark:border-emerald-800'"
          title="Toggle Data Source (Mock vs Live)">
           <i class="fas" [class]="apiService.useMockData() ? 'fa-database' : 'fa-globe'"></i>
        </button>
        
        <div class="hidden md:flex flex-col items-end border-l border-gray-200 dark:border-gray-700 pl-4 ml-1">
          <span class="text-sm font-bold text-gray-700 dark:text-gray-200">Admin User</span>
          <span class="text-[10px] text-gray-500 dark:text-gray-400">IT Manager</span>
        </div>

        <div class="w-9 h-9 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-sm border border-indigo-500 cursor-pointer shadow-sm hover:bg-indigo-700 transition-colors">
           A
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full flex flex-col">
    
    <!-- Navigation Tabs -->
    <div class="flex items-center justify-between mb-6">
      <nav class="flex space-x-1 bg-white dark:bg-gray-800 p-1 rounded-xl overflow-x-auto border border-gray-200 dark:border-gray-700 shadow-sm transition-colors">
        <a routerLink="/mapping" routerLinkActive="bg-gray-100 dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow-inner" 
           class="px-5 py-2 rounded-lg text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-all flex items-center gap-2 whitespace-nowrap">
           <i class="fas fa-link"></i> Mapping
        </a>
        <a routerLink="/orders" routerLinkActive="bg-gray-100 dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow-inner" 
           class="px-5 py-2 rounded-lg text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-all flex items-center gap-2 whitespace-nowrap">
           <i class="fas fa-clipboard-list"></i> Órdenes
        </a>
        <a routerLink="/logs" routerLinkActive="bg-gray-100 dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow-inner" 
           class="px-5 py-2 rounded-lg text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-all flex items-center gap-2 whitespace-nowrap">
           <i class="fas fa-exclamation-circle"></i> Logs
        </a>
        <a routerLink="/rules" routerLinkActive="bg-gray-100 dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow-inner" 
           class="px-5 py-2 rounded-lg text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-all flex items-center gap-2 whitespace-nowrap">
           <i class="fas fa-brain"></i> Reglas de Negocio
        </a>
        <a routerLink="/config" routerLinkActive="bg-gray-100 dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow-inner" 
           class="px-5 py-2 rounded-lg text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-all flex items-center gap-2 whitespace-nowrap">
           <i class="fas fa-cogs"></i> Configuración
        </a>
      </nav>
      
      <!-- Breadcrumb / Context Info -->
      <div class="hidden lg:block text-xs text-gray-400 dark:text-gray-500 font-mono">
         @if(apiService.selectedDealerCode()) {
           Contexto: <span class="text-gray-600 dark:text-gray-300 font-bold">{{ apiService.selectedDealerCode() }}</span>
         } @else {
           <span class="text-orange-500 font-bold"><i class="fas fa-exclamation-triangle"></i> Sin agencia seleccionada</span>
         }
      </div>
    </div>

    <!-- Router Outlet -->
    <div class="flex-1 relative">
      <router-outlet></router-outlet>
    </div>

  </main>
  
  <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 py-6 mt-auto transition-colors">
    <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-400 dark:text-gray-500">
      &copy; 2024 Daltonsoft Integrator for BYD.
    </div>
  </footer>

  <!-- TOAST NOTIFICATIONS CONTAINER -->
  <div class="fixed bottom-5 right-5 z-[9999] flex flex-col gap-2 pointer-events-none">
    @for (toast of notificationService.notifications(); track toast.id) {
      <div class="pointer-events-auto min-w-[300px] max-w-md p-4 rounded-lg shadow-xl border flex items-start gap-3 animate-slide-up transition-all transform hover:scale-[1.02] cursor-pointer dark:bg-gray-800"
           [ngClass]="{
             'bg-white border-green-200 dark:border-green-800': toast.type === 'success',
             'bg-white border-red-200 dark:border-red-800': toast.type === 'error',
             'bg-white border-blue-200 dark:border-blue-800': toast.type === 'info',
             'bg-white border-yellow-200 dark:border-yellow-800': toast.type === 'warning'
           }"
           (click)="removeNotification(toast.id)">
        
        <!-- Icon -->
        <div class="shrink-0 mt-0.5">
           @if(toast.type === 'success') { <i class="fas fa-check-circle text-green-500 text-lg"></i> }
           @if(toast.type === 'error') { <i class="fas fa-times-circle text-red-500 text-lg"></i> }
           @if(toast.type === 'info') { <i class="fas fa-info-circle text-blue-500 text-lg"></i> }
           @if(toast.type === 'warning') { <i class="fas fa-exclamation-triangle text-yellow-500 text-lg"></i> }
        </div>

        <!-- Content -->
        <div class="flex-1">
           <h4 class="font-bold text-sm"
             [ngClass]="{
               'text-green-700 dark:text-green-400': toast.type === 'success',
               'text-red-700 dark:text-red-400': toast.type === 'error',
               'text-blue-700 dark:text-blue-400': toast.type === 'info',
               'text-yellow-700 dark:text-yellow-400': toast.type === 'warning'
             }">
             @switch(toast.type) {
               @case('success') { Éxito }
               @case('error') { Error }
               @case('info') { Información }
               @case('warning') { Atención }
             }
           </h4>
           <p class="text-xs text-gray-600 dark:text-gray-300 mt-0.5">{{ toast.message }}</p>
        </div>

        <!-- Close -->
        <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <i class="fas fa-times"></i>
        </button>
      </div>
    }
  </div>
</div>
